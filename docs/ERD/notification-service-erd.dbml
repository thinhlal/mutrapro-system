// Notification Service ERD
// Service: notification-service
// Database: notification_db
// Người 4 (tuỳ chọn, có thể gộp)

// API Examples:
// POST /notify
//   - Body: { "user_id": "uuid", "title": "Task Assigned", "message": "You have been assigned a new task", "notification_type": "task_assignment" }
//   - Response: { "notification_id": "uuid", "status": "sent" }
//
// GET /notifications?userId=uuid
//   - Response: [{ "notification_id": "uuid", "title": "Task Assigned", "is_read": false, "created_at": "2024-01-15T10:30:00Z" }]
//
// Events: notification.sent

Table notifications {
  notification_id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [not null, note: 'Soft reference to identity-service']
  title varchar(200) [not null]
  message text [not null]
  notification_type notification_type [not null]
  is_read boolean [default: false]
  created_at timestamp [default: `now()`]
  
  Note: 'Hệ thống thông báo - Enhanced với notification types mới'
  
  indexes {
    user_id
    is_read
    notification_type
    created_at
  }
}

Table outbox_events {
  event_id uuid [pk, default: `gen_random_uuid()`]
  aggregate_id uuid [not null]
  aggregate_type text [not null]
  event_type text [not null]
  event_payload jsonb [not null]
  occurred_at timestamptz [not null, default: `now()`]
  published_at timestamptz
  retry_count integer [not null, default: 0]
  last_error text
  next_retry_at timestamptz
  trace_id text
  correlation_id text
  
  Note: 'Event publishing'
  
  indexes {
    aggregate_id
    aggregate_type
    event_type
    occurred_at
    (next_retry_at)
  }
}

Table consumed_events {
  event_id uuid [not null]
  consumer_name text [not null]
  processed_at timestamptz [not null, default: `now()`]
  
  Note: 'Idempotency - PK(event_id, consumer_name), INSERT ... ON CONFLICT DO NOTHING'
  
  indexes {
    (event_id, consumer_name) [unique, pk]
    consumer_name
    processed_at
  }
}

// Enums
Enum notification_type {
  task_assignment
  project_update
  payment_reminder
  booking_confirmation
  deadline_alert
  system_announcement
  contract_ready
  contract_signed
}