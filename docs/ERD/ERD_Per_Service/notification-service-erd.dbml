// Notification Service ERD
// Service: notification-service
// Database: notification_db
// Người 4 (tuỳ chọn, có thể gộp)

// API Examples:
// POST /notify
//   - Body: { "user_id": "uuid", "title": "Task Assigned", "message": "You have been assigned a new task", "notification_type": "task_assignment" }
//   - Response: { "notification_id": "uuid", "status": "sent" }
//
// GET /notifications?userId=uuid
//   - Response: [{ "notification_id": "uuid", "title": "Task Assigned", "is_read": false, "created_at": "2024-01-15T10:30:00Z" }]
//
// Events: notification.sent

Table notifications {
  notification_id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [not null, note: 'Soft ref to identity-service.users_auth']
  type notification_type [not null, note: 'Field name is "type", not "notification_type"']
  title varchar(255) [not null]
  content text [not null, note: 'Field name is "content", not "message"']
  reference_id uuid [note: 'Reference to related entity']
  reference_type varchar(50) [note: 'Type of referenced entity']
  action_url varchar(500) [note: 'URL for action button']
  is_read boolean [default: false]
  read_at timestamp [note: 'When notification was read']
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar(255)
  updated_by varchar(255)
  
  Note: '[NOTIFICATION SERVICE] System notifications - Extends BaseEntity'
  
  indexes {
    (user_id, created_at DESC)
    (user_id, is_read)
  }
}

Table outbox_events {
  event_id uuid [pk, default: `gen_random_uuid()`]
  aggregate_id uuid [not null]
  aggregate_type text [not null]
  event_type text [not null]
  event_payload jsonb [not null]
  occurred_at timestamptz [not null, default: `now()`]
  published_at timestamptz
  retry_count integer [not null, default: 0]
  last_error text
  next_retry_at timestamptz
  trace_id text
  correlation_id text
  
  Note: 'Event publishing'
  
  indexes {
    aggregate_id
    aggregate_type
    event_type
    occurred_at
    (next_retry_at)
  }
}

Table consumed_events {
  event_id uuid [not null]
  consumer_name varchar(100) [not null]
  processed_at timestamp [not null, default: `now()`]
  
  Note: '[NOTIFICATION SERVICE] Idempotency - PK(event_id, consumer_name), INSERT ... ON CONFLICT DO NOTHING'
  
  indexes {
    (event_id, consumer_name) [unique, pk]
    consumer_name
    processed_at
  }
}

// Enums
Enum notification_type {
  task_assignment
  project_update
  payment_reminder
  booking_confirmation
  deadline_alert
  system_announcement
  contract_ready
  contract_signed
}