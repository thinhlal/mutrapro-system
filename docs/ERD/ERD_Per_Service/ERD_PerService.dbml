// MuTraPro - ERD theo từng Microservice (Per-Service Databases) - Updated v4.1
// Database type: PostgreSQL
// 7 Services Architecture (File Service merged into Project Service)

Project MuTraPro_PerService {
  database_type: 'PostgreSQL'
  Note: '''
    ERD nhóm theo từng microservice để dễ theo dõi flow và ownership.
    Nguyên tắc: mỗi service sở hữu DB riêng; không FK cross-service; dùng soft references qua *_id.
    
    Services (7):
    1. identity-service (auth + profile)
    2. specialist-service 
    3. request-service (intake + catalog)
    4. project-service (contract + task + revision + file) ⭐
    5. studio-service
    6. billing-service (payment + wallet)
    7. notification-service
  '''
}

// =========================
// 1) IDENTITY-SERVICE (identity_db) - Gộp auth + profile
// =========================
Table users_auth {
  user_id uuid [pk]
  email varchar(100) [unique, not null]
  password_hash varchar(255) [not null]
  role user_role [not null]
  status varchar(20) [default: 'active']
  email_verified boolean [default: false]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
}

Table users {
  user_id uuid [pk, ref: > users_auth.user_id]
  full_name varchar(100) [not null]
  phone varchar(20)
  address text
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
}


Table refresh_tokens {
  id uuid [pk]
  user_id uuid [not null, ref: > users_auth.user_id]
  token_hash varchar(255) [unique, not null]
  issued_at timestamptz [default: `now()`]
  expires_at timestamptz [not null]
  revoked boolean [default: false]
  revoked_at timestamptz
}

Table outbox_events {
  event_id uuid [pk, default: `gen_random_uuid()`]
  aggregate_id uuid [not null]
  aggregate_type text [not null]
  event_type text [not null]
  event_payload jsonb [not null]
  occurred_at timestamptz [not null, default: `now()`]
  published_at timestamptz
  retry_count integer [not null, default: 0]
  last_error text
  next_retry_at timestamptz
  trace_id text
  correlation_id text
  
  indexes {
    aggregate_id
    aggregate_type
    event_type
    occurred_at
    (next_retry_at)
  }
}

Table consumed_events {
  event_id uuid [not null]
  consumer_name text [not null]
  processed_at timestamptz [not null, default: `now()`]
  
  indexes {
    (event_id, consumer_name) [unique, pk]
    consumer_name
    processed_at
  }
}

// ================================
// 2) SPECIALIST-SERVICE (specialist_db)
// ================================
Table specialists {
  specialist_id uuid [pk]
  user_id uuid [not null, note: 'Soft reference to identity-service']
  specialization specialist_type [not null]
  experience_years integer [default: 0]
  max_concurrent_tasks integer [default: 5]
  portfolio_url varchar(255)
  rating decimal(3,2) [default: 0.00]
  total_projects integer [default: 0]
  
  indexes {
    user_id [unique]
    specialization
    max_concurrent_tasks
  }
}

Table skills {
  skill_id uuid [pk]
  skill_name varchar(100) [not null]
  description text
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  
  indexes {
    skill_name [unique]
    is_active
  }
}

Table specialist_skills {
  specialist_skill_id uuid [pk]
  specialist_id uuid [ref: > specialists.specialist_id, not null]
  skill_id uuid [ref: > skills.skill_id, not null]
  proficiency_level proficiency_level [not null]
  years_experience integer [default: 0]
  last_used_date date
  is_certified boolean [default: false]
  certification_details text
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  indexes {
    (specialist_id, skill_id) [unique]
    specialist_id
    skill_id
    proficiency_level
    years_experience
  }
}

Table artist_demos {
  demo_id uuid [pk]
  specialist_id uuid [ref: > specialists.specialist_id, not null]
  title varchar(150)
  description text
  skill_id uuid [ref: > skills.skill_id]
  file_id uuid [note: 'Soft reference to project-service']
  preview_url varchar(500)
  is_public boolean [default: true]
  demo_order integer [default: 1]
  is_featured boolean [default: false]
  view_count integer [default: 0]
  customer_rating decimal(3,2)
  last_played_at timestamp
  created_at timestamp [default: `now()`]
  
  indexes {
    specialist_id
    is_public
    skill_id
    is_featured
    customer_rating
  }
}

// ==============================
// 3) REQUEST-SERVICE (request_db) - Gộp intake + catalog + feedback
// ==============================
Table service_requests {
  request_id uuid [pk]
  user_id uuid [not null, note: 'Soft reference to identity-service']
  manager_user_id uuid [note: 'Soft reference to identity-service']
  request_type service_type [not null]
  contact_name varchar(100)
  contact_phone varchar(20)
  contact_email varchar(100)
  music_options jsonb
  tempo_percentage decimal(5,2)
  has_vocalist boolean [default: false]
  external_guest_count integer [default: 0]
  title varchar(200)
  description text [not null]
  status request_status [default: 'pending']
  
  indexes {
    user_id
    manager_user_id
    status
    request_type
  }
}

Table request_booking_artists {
  request_booking_artist_id uuid [pk]
  request_id uuid [ref: > service_requests.request_id, not null]
  specialist_id uuid [not null, note: 'Soft reference to specialist-service']
  role recording_role [not null]
  skill_id uuid [note: 'Soft reference to specialist-service']
  
  indexes {
    request_id
    specialist_id
    (request_id, specialist_id, skill_id) [unique]
    role
    skill_id
  }
}

Table request_booking_equipment {
  request_booking_equipment_id uuid [pk]
  request_id uuid [ref: > service_requests.request_id, not null]
  equipment_id uuid [not null, note: 'Soft reference to equipment table']
  quantity integer [default: 1]
  
  indexes {
    request_id
    equipment_id
    (request_id, equipment_id) [unique]
  }
}

Table request_notation_instruments {
  request_instrument_id uuid [pk]
  request_id uuid [ref: > service_requests.request_id, not null]
  instrument_id uuid [ref: > notation_instruments.instrument_id, not null]
  
  indexes {
    request_id
    instrument_id
    (request_id, instrument_id) [unique]
  }
}

// Catalog tables
Table notation_instruments {
  instrument_id uuid [pk]
  instrument_name varchar(100) [not null]
  usage notation_instrument_usage [default: 'both']
  is_active boolean [default: true]
  
  indexes {
    instrument_name
    is_active
  }
}

Table equipment {
  equipment_id uuid [pk]
  equipment_name varchar(100) [not null]
  brand varchar(50)
  model varchar(100)
  description text
  specifications jsonb
  rental_fee decimal(12,2) [default: 0]
  total_quantity integer [default: 1]
  maintenance_quantity integer [default: 0]
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  indexes {
    equipment_name
    brand
    model
    (brand, model) [unique]
    is_active
    total_quantity
    maintenance_quantity
  }
}

Table skill_equipment_mapping {
  mapping_id uuid [pk]
  skill_id uuid [not null, note: 'Soft reference to specialist-service']
  equipment_id uuid [ref: > equipment.equipment_id, not null]
  
  indexes {
    skill_id
    equipment_id
    (skill_id, equipment_id) [unique]
  }
}

Table pricing_matrix {
  pricing_id uuid [pk]
  service_type service_type [not null]
  unit_type unit_type [not null]
  base_price decimal(12,2) [not null]
  currency currency_type [default: 'VND']
  description text
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  indexes {
    service_type
    currency
    is_active
  }
}

// Feedback table - MOVED FROM FEEDBACK-SERVICE
Table feedback {
  feedback_id uuid [pk]
  request_id uuid [ref: > service_requests.request_id, not null]
  user_id uuid [not null, note: 'Soft reference to identity-service']
  rating integer [not null]
  comment text
  feedback_type feedback_type [not null]
  created_at timestamp [default: `now()`]
}

// ============================
// 4) PROJECT-SERVICE (project_db) - Gộp contract + task + revision + file
// ============================
Table contracts {
  contract_id uuid [pk]
  request_id uuid [not null, note: 'Soft reference to request-service']
  user_id uuid [not null, note: 'Soft reference to identity-service']
  manager_user_id uuid [not null, note: 'Soft reference to identity-service']
  contract_number varchar(50) [unique, not null]
  contract_type contract_type [not null]
  terms_and_conditions text
  special_clauses text
  status contract_status [default: 'draft']
  created_at timestamp [default: `now()`]
  sent_to_customer_at timestamp
  customer_reviewed_at timestamp
  signed_at timestamp
  expires_at timestamp
  file_id uuid [ref: > files.file_id, note: 'Contract PDF file']
  notes text
  
  // Pricing
  base_price decimal(12,2) [default: 0]
  total_price decimal(12,2) [default: 0]
  currency currency_type [default: 'VND']
  deposit_percent decimal(5,2) [default: 40.0]
  deposit_amount decimal(12,2) [default: 0]
  final_amount decimal(12,2) [default: 0]
  
  // Deposit tracking
  deposit_paid boolean [default: false]
  deposit_paid_at timestamp
  
  // Timeline & SLA
  expected_start_date timestamp
  due_date timestamp
  sla_days integer [default: 0]
  auto_due_date boolean [default: true]
  
  // Revision policy
  free_revisions_included integer [default: 1]
  additional_revision_fee_vnd decimal(12,2) [default: 0]
  
  // Snapshot contact info
  name_snapshot varchar(255) [not null]
  phone_snapshot varchar(20) [not null]
  email_snapshot varchar(255) [not null]
  
  indexes {
    request_id
    user_id
    manager_user_id
    contract_number [unique]
    status
    contract_type
    expires_at
  }
}

Table service_sla_defaults {
  sla_id uuid [pk]
  contract_type contract_type [not null]
  min_sla_days integer [not null]
  max_sla_days integer [not null]
  default_buffer_days integer [default: 0]
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  
  indexes {
    contract_type [unique]
    is_active
  }
}

Table contract_milestones {
  milestone_id uuid [pk]
  contract_id uuid [ref: > contracts.contract_id, not null]
  
  // Thông tin mốc
  name varchar(100) [not null]
  description text
  
  // Chủ sở hữu mốc (specialist hoặc manager)
  owner_id uuid [not null, note: 'Soft reference to identity-service']
  
  // Timeline
  due_date timestamp
  
  // Trạng thái
  status milestone_work_status [default: 'planned']
  
  created_at timestamp [default: `now()`]
  updated_at timestamp
  
  indexes {
    contract_id
    owner_id
    status
    due_date
  }
}

Table task_assignments {
  assignment_id uuid [pk]
  contract_id uuid [ref: > contracts.contract_id, not null]
  specialist_id uuid [not null, note: 'Soft reference to specialist-service']
  task_type task_type [not null]
  status assignment_status [default: 'assigned']
  
  // Gán task vào mốc công việc
  milestone_id uuid [note: 'Soft reference to contract_milestones in project-service']
  
  assigned_date timestamp [default: `now()`]
  completed_date timestamp
  notes text
  specialist_can_do boolean
  specialist_response_reason text
  specialist_responded_at timestamp
  used_revisions integer [default: 0]
  
  indexes {
    contract_id
    specialist_id
    milestone_id
    status
    specialist_can_do
    task_type
  }
}

Table revision_requests {
  revision_id uuid [pk]
  contract_id uuid [ref: > contracts.contract_id, not null]
  assignment_id uuid [ref: > task_assignments.assignment_id]
  file_id uuid [ref: > files.file_id, not null, note: 'File to be revised']
  requested_by uuid [not null, note: 'Soft reference to identity-service']
  revision_number integer [not null]
  description text [not null]
  payment_required boolean [default: false]
  payment_status payment_status [default: 'not_required']
  status revision_status [default: 'pending']
  requested_at timestamp [default: `now()`]
  completed_at timestamp
  approved_by uuid [note: 'Soft reference to identity-service']
  approved_at timestamp
  rejected_by uuid [note: 'Soft reference to identity-service']
  rejected_at timestamp
  rejection_reason text
  
  indexes {
    contract_id
    assignment_id
    file_id [unique]  // 1 file chỉ có 1 revision request
    requested_by
    (contract_id, revision_number) [unique]
    (contract_id, status)
    status
    requested_at
    approved_by
    approved_at
    rejected_by
    rejected_at
  }
}

// Files table - MOVED FROM FILE-SERVICE
Table files {
  file_id uuid [pk]
  request_id uuid [note: 'Soft reference to request-service']
  assignment_id uuid [ref: > task_assignments.assignment_id, note: 'Task deliverables']
  booking_id uuid [note: 'Soft reference to studio-service']
  file_name varchar(255) [not null]
  file_path varchar(500) [not null]
  file_size bigint [not null]
  mime_type varchar(100)
  file_source file_source_type [not null]
  content_type content_type [not null]
  description text
  upload_date timestamp [default: `now()`]
  created_by uuid [not null, note: 'Soft reference to identity-service']
  delivered_to_customer boolean [default: false]
  delivered_at timestamp
  delivered_by uuid [note: 'Soft reference to identity-service']
  file_status file_status [default: 'uploaded']
  rejection_reason text
  reviewed_by uuid [note: 'Soft reference to identity-service']
  reviewed_at timestamp
  
  indexes {
    request_id
    assignment_id
    booking_id
    file_source
    content_type
    created_by
    upload_date
    delivered_to_customer
    delivered_at
    delivered_by
    file_status
    reviewed_by
    reviewed_at
  }
}

// ==========================
// 5) STUDIO-SERVICE (studio_db)
// ==========================
Table studios {
  studio_id uuid [pk]
  studio_name varchar(100) [not null, default: 'MuTraPro Studio']
  location varchar(255) [not null]
  hourly_rate decimal(10,2) [default: 200000]
  free_external_guests_limit integer [default: 3]
  extra_guest_fee_per_person decimal(12,2) [default: 50000]
  is_active boolean [default: true]
  
  indexes {
    is_active
  }
}

Table studio_bookings {
  booking_id uuid [pk]
  user_id uuid [not null, note: 'Soft reference to identity-service']
  studio_id uuid [ref: > studios.studio_id, not null]
  request_id uuid [note: 'Soft reference to request-service']
  contract_id uuid [note: 'Soft reference to project-service']
  session_type recording_session_type [not null]
  booking_date date [not null]
  start_time time [not null]
  end_time time [not null]
  status booking_status [default: 'tentative']
  hold_expires_at timestamp
  billing_step_hours decimal(3,2) [default: 0.50]
  min_billing_hours decimal(3,2) [default: 1.00]
  external_guest_count integer [default: 0]
  duration_hours decimal(5,2) [not null]
  artist_fee decimal(12,2) [default: 0]
  equipment_rental_fee decimal(12,2) [default: 0]
  admin_fee decimal(12,2) [default: 0]
  external_guest_fee decimal(12,2) [default: 0]
  total_cost decimal(12,2) [default: 0]
  purpose text
  special_instructions text
  notes text
  created_at timestamp [default: `now()`]
  
  indexes {
    user_id
    studio_id
    request_id
    contract_id
    session_type
    booking_date
    status
  }
}

// ===========================
// 6) BILLING-SERVICE (billing_db) - Gộp payment + wallet
// ===========================
Table wallets {
  wallet_id uuid [pk]
  user_id uuid [ref: > users.user_id, unique, not null]
  balance decimal(14,2) [default: 0]
  currency currency_type [default: 'VND']
  status wallet_status [default: 'active']
  created_at timestamp [default: `now()`]
  
  indexes {
    user_id [unique]
    status
  }
}

Table wallet_transactions {
  wallet_tx_id uuid [pk]
  wallet_id uuid [ref: > wallets.wallet_id, not null]
  tx_type wallet_tx_type [not null]
  amount decimal(14,2) [not null]
  currency currency_type [default: 'VND']
  balance_before decimal(14,2) [not null]
  balance_after decimal(14,2) [not null]
  metadata jsonb
  
  // Truy vết giao dịch đến thực thể
  contract_id uuid [note: 'Soft reference to project-service']
  milestone_id uuid [note: 'Soft reference to project-service - contract_milestones']
  booking_id uuid [note: 'Soft reference to studio-service']
  refund_of_wallet_tx_id uuid [ref: > wallet_transactions.wallet_tx_id]
  
  created_at timestamp [default: `now()`]
  
  indexes {
    wallet_id
    tx_type
    currency
    contract_id
    milestone_id
    booking_id
    refund_of_wallet_tx_id
    created_at
  }
}

// Table contract_installments - ĐÃ XÓA
// Đã được thay thế hoàn toàn bởi contract_milestones trong project-service
// contract_milestones quản lý cả công việc và thanh toán trong cùng một entity

// Table payments - NOT USED
// Thông tin payment được lưu trong wallet_transactions.metadata (JSONB)

// ===============================
// 7) NOTIFICATION-SERVICE (notification_db)
// ===============================
Table notifications {
  notification_id uuid [pk]
  user_id uuid [not null, note: 'Soft reference to identity-service']
  title varchar(200) [not null]
  message text [not null]
  notification_type notification_type [not null]
  is_read boolean [default: false]
  created_at timestamp [default: `now()`]
  
  indexes {
    user_id
    is_read
    notification_type
    created_at
  }
}

// ==============================
// ENUMS
// ==============================

Enum user_role {
  customer
  manager
  transcription_specialist
  arrangement_specialist
  recording_artist
  system_admin
}

Enum specialist_type {
  transcription
  arrangement
  recording
}

Enum proficiency_level {
  beginner
  intermediate
  advanced
  expert
}

Enum service_type {
  transcription
  arrangement
  arrangement_with_recording
  recording
}

Enum unit_type {
  per_minute
  per_song
  per_hour
  fixed_price
}

Enum currency_type {
  VND
  USD
  EUR
}

Enum request_status {
  pending
  contract_sent
  contract_signed
  approved
  in_progress
  completed
  cancelled
  rejected
}

Enum recording_role {
  vocalist
  instrumentalist
  both
}

Enum notation_instrument_usage {
  transcription
  arrangement
  both
}

Enum feedback_type {
  service_quality
  communication
  timeliness
  overall_experience
}

Enum contract_type {
  transcription
  arrangement
  arrangement_with_recording
  recording
}

Enum contract_status {
  draft
  sent_to_customer
  customer_reviewing
  signed
  expired
  cancelled
}

Enum milestone_type {
  deposit
  final_payment
  revision_fee
}

Enum milestone_work_status {
  planned
  in_progress
  submitted
  accepted
  rejected
}

// Enum installment_status - ĐÃ XÓA
// Đã được thay thế bởi milestone_payment_status trong project-service

Enum gate_condition {
  before_start
  after_accept
  after_delivery
}

Enum task_type {
  transcription
  arrangement
  recording
}

Enum assignment_status {
  assigned
  in_progress
  completed
  cancelled
}

Enum revision_status {
  pending
  approved
  rejected
  in_progress
  completed
  cancelled
}

Enum payment_status {
  not_required
  pending
  processing
  completed
  failed
  refunded
  cancelled
}

Enum file_source_type {
  customer_upload
  task_deliverable
  studio_recording
}

Enum content_type {
  audio
  sheet_music
  project_file
  documentation
  video
  archive
}

Enum file_status {
  uploaded
  pending_review
  approved
  rejected
  delivered
  revision_requested
}

Enum recording_session_type {
  self_recording
  artist_assisted
  hybrid
}

Enum booking_status {
  tentative
  pending
  confirmed
  in_progress
  completed
  cancelled
  no_show
}

Enum payment_method {
  credit_card
  debit_card
  bank_transfer
  digital_wallet
  wallet
  cash
}

Enum wallet_status {
  active
  locked
  closed
}

Enum wallet_tx_type {
  topup
  payment
  refund
  withdrawal
  adjustment
}

Enum notification_type {
  task_assignment
  project_update
  payment_reminder
  booking_confirmation
  deadline_alert
  system_announcement
  contract_ready
  contract_signed
}


