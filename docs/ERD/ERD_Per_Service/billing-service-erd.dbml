// Billing Service ERD
// Service: billing-service (gộp payment + wallet)
// Database: billing_db
// Người 3 (phần còn lại)

// API Examples with Idempotency:
// POST /wallets/{id}/topup
//   - Headers: X-Idempotency-Key: "topup_2024_001"
//   - Body: { "amount": 100000, "currency": "VND" }
//
// POST /wallets/{id}/debit
//   - Headers: X-Idempotency-Key: "debit_payment_12345"
//   - Body: { "amount": 50000, "currency": "VND", "payment_id": "uuid" }
//
// POST /payments
//   - Headers: X-Idempotency-Key: "payment_installment_67890"
//   - Body: { "installment_id": "uuid", "amount": 200000, "payment_method": "wallet" }
//
// Events: wallet.debited|refunded, payment.completed|failed

Table wallets {
  wallet_id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [unique, not null, note: 'Soft reference to identity-service']
  balance decimal(14,2) [default: 0]
  currency currency_type [default: 'VND']
  status wallet_status [default: 'active']
  created_at timestamp [default: `now()`]
  
  Note: 'Ví điện tử của người dùng. Mỗi user có 1 ví duy nhất.'
  
  indexes {
    user_id [unique]
    status
    currency
  }
}

Table wallet_transactions {
  wallet_tx_id uuid [pk, default: `gen_random_uuid()`]
  wallet_id uuid [ref: > wallets.wallet_id, not null]
  tx_type wallet_tx_type [not null]
  amount decimal(14,2) [not null]
  currency currency_type [default: 'VND']
  balance_before decimal(14,2) [not null]
  balance_after decimal(14,2) [not null]
  metadata jsonb
  
  // Truy vết giao dịch đến thực thể
  contract_id uuid [note: 'Soft reference to project-service']
  installment_id uuid [note: 'Soft reference to project-service']
  booking_id uuid [note: 'Soft reference to project-service']
  refund_of_wallet_tx_id uuid [ref: > wallet_transactions.wallet_tx_id]
  
  created_at timestamp [default: `now()`]
  
  Note: 'Sổ cái giao dịch ví. Ghi nhận mọi biến động số dư với balance_before/after để audit. Truy vết đến contract/installment/booking để audit trail đầy đủ.'
  
  indexes {
    wallet_id
    tx_type
    currency
    contract_id
    installment_id
    booking_id
    refund_of_wallet_tx_id
    created_at
  }
}

Table contract_installments {
  installment_id uuid [pk, default: `gen_random_uuid()`]
  contract_id uuid [not null, note: 'Soft reference to project-service']
  
  // Thông tin đợt
  label varchar(50) [not null] // Deposit, Phase 1, Phase 2, Final
  due_date timestamp
  
  // Số tiền
  amount decimal(12,2) [not null]
  currency currency_type [default: 'VND']
  
  // Trạng thái
  status installment_status [default: 'pending']
  
  // Đánh dấu cọc
  is_deposit boolean [default: false]
  
  // Liên kết với mốc công việc (optional)
  milestone_id uuid [note: 'Soft reference to project-service - contract_milestones']
  
  // Điều kiện thanh toán
  gate_condition gate_condition
  
  // Khấu trừ từ reservation fee hoặc credit khác
  applied_credit_amount decimal(12,2) [default: 0]
  
  created_at timestamp [default: `now()`]
  paid_at timestamp
  
  Note: 'Đợt thanh toán trong hợp đồng - Tự động tạo Deposit và Final khi tạo hợp đồng từ deposit_percent'
  
  indexes {
    contract_id
    status
    is_deposit
    due_date
  }
}

// Table payments - NOT USED
// Thông tin payment được lưu trong wallet_transactions.metadata (JSONB)
// - Topup: metadata.payment_method = "sepay_qr", metadata.sepay_transaction_id, metadata.gateway_response
// - Payment: metadata.payment_method = "wallet", đã có installment_id trong wallet_transactions
// 
// Table payments {
//   payment_id uuid [pk, default: `gen_random_uuid()`]
//   ...
// }

Table outbox_events {
  event_id uuid [pk, default: `gen_random_uuid()`]
  aggregate_id uuid [not null]
  aggregate_type text [not null]
  event_type text [not null]
  event_payload jsonb [not null]
  occurred_at timestamptz [not null, default: `now()`]
  published_at timestamptz
  retry_count integer [not null, default: 0]
  last_error text
  next_retry_at timestamptz
  trace_id text
  correlation_id text
  
  Note: 'Event publishing'
  
  indexes {
    aggregate_id
    aggregate_type
    event_type
    occurred_at
    (next_retry_at)
  }
}

Table consumed_events {
  event_id uuid [not null]
  consumer_name text [not null]
  processed_at timestamptz [not null, default: `now()`]
  
  Note: 'Idempotency - PK(event_id, consumer_name), INSERT ... ON CONFLICT DO NOTHING'
  
  indexes {
    (event_id, consumer_name) [unique, pk]
    consumer_name
    processed_at
  }
}

// Enums
Enum currency_type {
  VND
  USD
  EUR
}

Enum wallet_status {
  active
  locked
  closed
}

Enum wallet_tx_type {
  topup
  payment
  refund
  withdrawal
  adjustment
}

Enum payment_method {
  credit_card
  debit_card
  bank_transfer
  digital_wallet
  wallet
  cash
}

Enum payment_status {
  not_required
  pending
  processing
  completed
  failed
  refunded
  cancelled
}

Enum installment_status {
  pending
  paid
  overdue
  cancelled
}

Enum gate_condition {
  before_start
  after_accept
  after_delivery
}