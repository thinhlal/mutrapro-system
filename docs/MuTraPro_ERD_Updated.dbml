// ERD HOÀN CHỈNH cho hệ thống MuTraPro - UPDATED VERSION
// Custom Music Transcription and Production System
// Tác giả: [Tên sinh viên]
// Ngày tạo: [Ngày hiện tại]
// Version: 3.0 - Enhanced Workflow Support
// Updated: 2025 - Support for 3 Main Workflows

Project MuTraPro {
  database_type: 'PostgreSQL'
  Note: '''
    Hệ thống ký âm và sản xuất âm nhạc theo yêu cầu
    Custom Music Transcription and Production System
    
    Enhanced Features v3.0:
    - Multi-role user management
    - Automated contract system
    - Milestone-based payments
    - Single studio booking management
    - Complete workflow tracking
    - AI-assisted transcription
    - Contract management system
    - Enhanced arrangement workflow
    - Artist recommendation system
    
    Main Workflows:
    1. Transcription with AI assistance
    2. Arrangement with optional vocalist + Contract management
    3. Studio booking with multi-artist selection
    
    Studio System: Chỉ quản lý 1 studio duy nhất (MuTraPro Studio)
  '''
}

// ===== CÁC THỰC THỂ CHÍNH =====

// 1. Người dùng (Users) - Enhanced with primary_role
Table users {
  user_id uuid [pk, default: `gen_random_uuid()`]
  email varchar(100) [unique, not null]
  password_hash varchar(255) [not null]
  full_name varchar(100) [not null]
  role user_role [not null]
  phone varchar(20)
  address text
  is_active boolean [default: true]
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Note: 'Bảng chứa thông tin người dùng. Gộp customers và managers, chỉ giữ specialists riêng.'
  
  indexes {
    is_active
    role
  }
}

// 2.1. Ví điện tử (Wallets)
Table wallets {
  wallet_id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [ref: > users.user_id, unique, not null]
  balance decimal(14,2) [default: 0] // Số dư hiện tại
  currency currency_type [default: 'VND']
  status wallet_status [default: 'active']
  created_at timestamp [default: `now()`]
  
  Note: 'Ví điện tử của người dùng. Mỗi user có 1 ví duy nhất.'
  
  indexes {
    user_id [unique]
    status
  }
}

// 2.2. Giao dịch ví (Wallet Transactions)
Table wallet_transactions {
  wallet_tx_id uuid [pk, default: `gen_random_uuid()`]
  wallet_id uuid [ref: > wallets.wallet_id, not null]
  tx_type wallet_tx_type [not null] // topup(+), payment(-), refund(+), withdrawal(-), adjustment(+/-)
  amount decimal(14,2) [not null] // Luôn là số dương, dấu suy từ tx_type
  currency currency_type [default: 'VND'] // Đồng tiền giao dịch
  balance_before decimal(14,2) [not null] // Số dư trước giao dịch
  balance_after decimal(14,2) [not null] // Số dư sau giao dịch
  related_payment_id uuid [ref: > payments.payment_id] // Nullable, liên kết payment nếu có
  metadata jsonb // Mã GD cổng nạp, lý do hoàn, v.v.
  created_at timestamp [default: `now()`]
  
  Note: 'Sổ cái giao dịch ví. Ghi nhận mọi biến động số dư với balance_before/after để audit.'
  
  indexes {
    wallet_id
    tx_type
    currency
    related_payment_id
    created_at
  }
}

// 3. Chuyên gia (Specialists) - Dynamic workload management
Table specialists {
  specialist_id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [ref: > users.user_id, not null]
  specialization specialist_type [not null]
  experience_years integer [default: 0]
  hourly_rate decimal(10,2)
  
  // Capacity management (simplified)
  max_concurrent_tasks integer [default: 5] // Số task tối đa có thể làm cùng lúc
  
  // Professional info
  portfolio_url varchar(255)
  rating decimal(3,2) [default: 0.00]
  total_projects integer [default: 0]
  
  Note: 'Thông tin chuyên gia - current_workload tính động qua view, không lưu để tránh lệch dữ liệu'
  
  indexes {
    user_id [unique] // 1 user ↔ 1 specialist
    specialization
    max_concurrent_tasks
  }
}

// 3.1. Skills (Kỹ năng cụ thể) - Đơn giản hóa, bỏ categories
Table skills {
  skill_id uuid [pk, default: `gen_random_uuid()`]
  skill_name varchar(100) [not null]
  description text
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  
  Note: 'Kỹ năng cụ thể: Piano, Guitar, Drums, Vocal, Audio Engineering, Logic Pro, etc.'
  
  indexes {
    skill_name [unique]
    is_active
  }
}

// 3.2. Specialist Skills (Kỹ năng của từng specialist)
Table specialist_skills {
  specialist_skill_id uuid [pk, default: `gen_random_uuid()`]
  specialist_id uuid [ref: > specialists.specialist_id, not null]
  skill_id uuid [ref: > skills.skill_id, not null]
  proficiency_level proficiency_level [not null]
  years_experience integer [default: 0]
  last_used_date date
  is_certified boolean [default: false]
  certification_details text
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Note: 'Kỹ năng của specialist với level và kinh nghiệm cụ thể'
  
  indexes {
    (specialist_id, skill_id) [unique]
    specialist_id
    skill_id
    proficiency_level
    years_experience
  }
}

// 3.4. Artist Demos (Demo giọng/nhạc cụ của nghệ sĩ) - ENHANCED
Table artist_demos {
  demo_id uuid [pk, default: `gen_random_uuid()`]
  specialist_id uuid [ref: > specialists.specialist_id, not null]
  title varchar(150)
  description text
  skill_id uuid [ref: > skills.skill_id] // skill được demo (piano, guitar, vocal, etc.)
  file_id uuid [ref: > files.file_id] // file audio demo nội bộ
  preview_url varchar(500) // URL demo ngoài hệ thống (nếu có)
  is_public boolean [default: true]
  
  // NEW FIELDS v3.0
  demo_order integer [default: 1] // Thứ tự hiển thị demo
  is_featured boolean [default: false] // Demo nổi bật
  view_count integer [default: 0] // Số lần xem
  customer_rating decimal(3,2) // Đánh giá từ khách hàng (0.00-5.00)
  last_played_at timestamp // Lần cuối được nghe
  
  created_at timestamp [default: `now()`]
  
  Note: 'Demo để khách nghe thử giọng/nhạc cụ của nghệ sĩ trước khi booking. Enhanced với tracking và rating.'
  
  indexes {
    specialist_id
    is_public
    skill_id
    is_featured
    customer_rating
  }
}


// 5. Studio (Single Studio System)
Table studios {
  studio_id uuid [pk, default: `gen_random_uuid()`]
  studio_name varchar(100) [not null, default: 'MuTraPro Studio']
  location varchar(255) [not null]
  hourly_rate decimal(10,2) [default: 200000] // Phí thuê studio/giờ
  free_external_guests_limit integer [default: 3] // Số khách ngoài free
  extra_guest_fee_per_person decimal(12,2) [default: 50000] // Phí cho mỗi khách ngoài vượt quá limit
  is_active boolean [default: true]
  
  Note: 'Thông tin studio ghi âm với giá thuê và policy khách ngoài'
  
  indexes {
    is_active
  }
}

// 5.1. Equipment (Thiết bị cụ thể) - Đơn giản hóa, bỏ categories
Table equipment {
  equipment_id uuid [pk, default: `gen_random_uuid()`]
  equipment_name varchar(100) [not null]
  brand varchar(50)
  model varchar(100)
  description text
  specifications jsonb // Technical specs as JSON
  rental_fee decimal(12,2) [default: 0] // Phí thuê thiết bị mặc định
  
  total_quantity integer [default: 1] // Tổng số thiết bị cùng loại
  maintenance_quantity integer [default: 0] // Số đang bảo trì
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Note: 'Thiết bị cụ thể: Yamaha C3 Piano, Fender Stratocaster Guitar, Pearl Drum Kit, etc.'
  
  indexes {
    equipment_name
    brand
    model
    (brand, model) [unique] // Mỗi thiết bị có brand+model duy nhất
    is_active
    total_quantity
    maintenance_quantity
  }
}


// 5.2. Skill Equipment Mapping (Liên kết skill nhạc cụ với equipment phù hợp)
Table skill_equipment_mapping {
  mapping_id uuid [pk, default: `gen_random_uuid()`]
  skill_id uuid [ref: > skills.skill_id, not null]
  equipment_id uuid [ref: > equipment.equipment_id, not null]
  
  Note: 'Mapping skill với equipment phù hợp. Customer tự chọn equipment từ danh sách này. VD: Piano skill → [Yamaha C3, Steinway Model D, Digital Piano]'
  
  indexes {
    skill_id
    equipment_id
    (skill_id, equipment_id) [unique]
  }
}


// 5.3. Notation Instruments (Nhạc cụ ảo cho ký âm)
Table notation_instruments {
  instrument_id uuid [pk, default: `gen_random_uuid()`]
  instrument_name varchar(100) [not null]
  usage notation_instrument_usage [default: 'both'] // Dùng cho transcription/arrangement/both
  is_active boolean [default: true]

  Note: 'Danh mục nhạc cụ ảo dùng trong ký âm/notation trên máy (không phải thiết bị thật)'

  indexes {
    instrument_name
    is_active
  }
}

// 5.4. Request Notation Instruments (Nhạc cụ ảo theo request - multi-select for arrangement)
Table request_notation_instruments {
  request_instrument_id uuid [pk, default: `gen_random_uuid()`]
  request_id uuid [ref: > service_requests.request_id, not null]
  instrument_id uuid [ref: > notation_instruments.instrument_id, not null]

  Note: 'Danh sách nhạc cụ ảo được chọn cho từng request. Dùng chủ yếu cho Arrangement (đa chọn). Luồng 1 Transcription giữ 1 nhạc cụ chính ở service_requests.requested_instrument_id.'

  indexes {
    request_id
    instrument_id
    (request_id, instrument_id) [unique]
  }
}


// 6. Bảng giá chuẩn (Pricing Matrix) - ENHANCED for Arrangement
Table pricing_matrix {
  pricing_id uuid [pk, default: `gen_random_uuid()`]
  service_type service_type [not null]
  unit_type unit_type [not null]
  base_price decimal(12,2) [not null]
  currency currency_type [default: 'VND']
  description text
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Note: 'Bảng giá chuẩn theo service type và unit type'
  
  indexes {
    service_type
    currency
    is_active
  }
}

// 7. Yêu cầu dịch vụ (Service Requests) - ENHANCED
Table service_requests {
  request_id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [ref: > users.user_id, not null]
  manager_user_id uuid [ref: > users.user_id]
  request_type service_type [not null]
  
  // Thông tin cá nhân
  contact_name varchar(100) // Tên liên hệ
  contact_phone varchar(20) // Số điện thoại
  contact_email varchar(100) // Email
  
  music_options jsonb // VD: { "genres": ["Pop","Rock"], "purpose": "karaoke_cover" } - NULL cho transcription
  tempo_percentage decimal(5,2) // VD: 80.00, 50.00 (tốc độ phát cho transcription)
  has_vocalist boolean [default: false] // Customer có chọn ca sĩ cho arrangement_with_recording
  external_guest_count integer [default: 0] // Số người customer mang theo cho studio booking
  title varchar(200)
  description text [not null]
  status request_status [default: 'pending']
  
  Note: 'Yêu cầu dịch vụ từ khách hàng. tempo_percentage dùng cho transcription (80% = chậm 20%, 50% = chậm 50%). has_vocalist: true nếu customer chọn ca sĩ. music_options: NULL cho transcription. external_guest_count: số người customer mang theo cho studio booking. contact_*: thông tin cá nhân linh hoạt.'
  
  indexes {
    user_id
    manager_user_id
    status
    request_type
  }
}

// 7.1. Request Booking Artists (Nghệ sĩ customer chọn cho studio booking)
Table request_booking_artists {
  request_booking_artist_id uuid [pk, default: `gen_random_uuid()`]
  request_id uuid [ref: > service_requests.request_id, not null]
  specialist_id uuid [ref: > specialists.specialist_id, not null]
  role recording_role [not null] // vocalist | instrumentalist | both
  skill_id uuid [ref: > skills.skill_id] // skill được sử dụng trong phiên
  
  Note: 'Nghệ sĩ customer chọn cho studio booking. Dùng cho luồng 2 (arrangement_with_recording) và luồng 3 (recording).'
  
  indexes {
    request_id
    specialist_id
    (request_id, specialist_id, skill_id) [unique]
    role
    skill_id
  }
}

// 7.2. Request Booking Equipment (Thiết bị customer chọn cho studio booking)
Table request_booking_equipment {
  request_booking_equipment_id uuid [pk, default: `gen_random_uuid()`]
  request_id uuid [ref: > service_requests.request_id, not null]
  equipment_id uuid [ref: > equipment.equipment_id, not null]
  quantity integer [default: 1]
  
  Note: 'Thiết bị customer chọn cho studio booking. Dùng cho luồng 2 (arrangement_with_recording) và luồng 3 (recording).'
  
  indexes {
    request_id
    equipment_id
    (request_id, equipment_id) [unique]
  }
}

// 9. Contracts (UPDATED v3.2 - holds pricing breakdown & links directly to request)
Table contracts {
  contract_id uuid [pk, default: `gen_random_uuid()`]
  request_id uuid [ref: > service_requests.request_id, not null]
  user_id uuid [ref: > users.user_id, not null]
  manager_user_id uuid [ref: > users.user_id, not null]
  contract_number varchar(50) [unique, not null]
  contract_type contract_type [not null]
  terms_and_conditions text
  special_clauses text
  status contract_status [default: 'draft']
  created_at timestamp [default: `now()`]
  sent_to_customer_at timestamp
  customer_reviewed_at timestamp
  signed_at timestamp
  expires_at timestamp
  file_id uuid [ref: > files.file_id] // Contract PDF
  notes text

  // Pricing đơn giản hóa (auto from system)
  base_price decimal(12,2) [default: 0]
  total_price decimal(12,2) [default: 0]
  currency currency_type [default: 'VND']
  deposit_percent decimal(5,2) [default: 40.0]
  deposit_amount decimal(12,2) [default: 0]
  final_amount decimal(12,2) [default: 0]
  
  // Deposit tracking
  deposit_paid boolean [default: false]
  deposit_paid_at timestamp

  // Timeline & SLA (SIMPLIFIED v3.10)
  expected_start_date timestamp // Ngày dự kiến bắt đầu
  due_date timestamp            // Hạn hoàn thành theo hợp đồng (tính từ max_sla_days)
  sla_days integer [default: 0] // Số ngày SLA max (lấy từ service_sla_defaults.max_sla_days)
  auto_due_date boolean [default: true] // true: due_date = expected_start_date + sla_days
  
  // Revision policy (SIMPLIFIED v3.11)
  free_revisions_included integer [default: 1] // Số lần revision miễn phí cho toàn contract
  additional_revision_fee_vnd decimal(12,2) [default: 0] // Phí revision thêm
  
  // Snapshot thông tin liên hệ từ service_requests (đóng băng pháp lý)
  name_snapshot varchar(255) [not null]
  phone_snapshot varchar(20) [not null]
  email_snapshot varchar(255) [not null]
  
  Note: 'Hợp đồng quản lý - Manager tạo hợp đồng trực tiếp từ request với giá tự động. Revision chỉ áp dụng cho transcription và arrangement tasks, không áp dụng cho recording. Snapshot contact info để đóng băng pháp lý - không thay đổi sau khi ký hợp đồng.'
  
  indexes {
    request_id
    user_id
    manager_user_id
    contract_number [unique]
    status
    contract_type
    expires_at
  }
}

// 8. SLA mặc định theo loại hợp đồng (Service SLA Defaults)
Table service_sla_defaults {
  sla_id uuid [pk, default: `gen_random_uuid()`]
  contract_type contract_type [not null]    // transcription | arrangement | arrangement_with_recording | recording 
  min_sla_days integer [not null]           // ví dụ: 3, 4, 5
  max_sla_days integer [not null]           // ví dụ: 5, 8, 10 (arrangement_with_recording = 5+3)
  default_buffer_days integer [default: 0]  // ngày đệm
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]

  Note: 'SLA mặc định theo loại hợp đồng'

  indexes {
    contract_type [unique]
    is_active
  }
}


// 10. Thanh toán theo giai đoạn (Payment Milestones)
Table payment_milestones {
  milestone_id uuid [pk, default: `gen_random_uuid()`]
  contract_id uuid [ref: > contracts.contract_id, not null]
  
  milestone_type milestone_type [not null]
  milestone_name varchar(100) [not null]
  description text
  amount decimal(12,2) [not null]
  percentage decimal(5,2) [not null]
  
  // Điều kiện kích hoạt
  trigger_condition trigger_condition [not null]
  required_deliverable_count integer [default: 0]
  
  // Trạng thái thanh toán
  status milestone_status [default: 'pending']
  due_date timestamp
  completed_at timestamp
  
  Note: 'Các mốc thanh toán theo giai đoạn - request_id và user_id lấy qua contract_id'
  
  indexes {
    contract_id
    milestone_type
    status
    due_date
  }
}

// 11. Phân công công việc (Task Assignments) - SIMPLIFIED v3.11
Table task_assignments {
  assignment_id uuid [pk, default: `gen_random_uuid()`]
  contract_id uuid [ref: > contracts.contract_id, not null]
  specialist_id uuid [ref: > specialists.specialist_id, not null]
  task_type task_type [not null]
  status assignment_status [default: 'assigned']
  
  // Timeline management (simplified)
  assigned_date timestamp [default: `now()`]
  
  // Completion tracking
  completed_date timestamp
  notes text
  
  // Specialist response (optional flags)
  specialist_can_do boolean // null = chưa phản hồi, true/false = phản hồi
  specialist_response_reason text
  specialist_responded_at timestamp
  
  // Revision tracking (chỉ cho transcription và arrangement)
  used_revisions integer [default: 0] // Số lần revision đã sử dụng cho task này
  
  Note: 'Phân công task trực tiếp từ contract - Revision chỉ áp dụng cho transcription/arrangement. CHECK: task_type phải khớp với contract.contract_type (transcription, arrangement, recording)'
  
  indexes {
    contract_id
    specialist_id
    status
    specialist_can_do
    task_type
  }
}

// 12. File Management (Unified Files Table) - ENHANCED
Table files {
  file_id uuid [pk, default: `gen_random_uuid()`]
  
  // Source references (one of these will be NULL)
  request_id uuid [ref: > service_requests.request_id]           // Customer uploads
  assignment_id uuid [ref: > task_assignments.assignment_id]     // Task deliverables
  booking_id uuid [ref: > studio_bookings.booking_id]            // Studio recordings (single studio)
  
  // File metadata
  file_name varchar(255) [not null]
  file_path varchar(500) [not null]
  file_size bigint [not null]
  mime_type varchar(100)   
  
  // File classification
  file_source file_source_type [not null]
  content_type content_type [not null]
  
  // General metadata
  description text
  upload_date timestamp [default: `now()`]
  created_by uuid [ref: > users.user_id] // WHO uploaded this
  
  // Delivery tracking (đơn giản)
  delivered_to_customer boolean [default: false] // true = đã gửi cho customer
  delivered_at timestamp // Khi nào gửi
  delivered_by uuid [ref: > users.user_id] // Ai gửi (thường là manager)
  
  // File status tracking
  file_status file_status [default: 'uploaded'] // Trạng thái file
  rejection_reason text // Lý do từ chối (nếu có)
  reviewed_by uuid [ref: > users.user_id] // Ai duyệt file
  reviewed_at timestamp // Khi nào duyệt
  
  Note: 'Quản lý tất cả files trong hệ thống - Enhanced với notation editor và AI support. Theo dõi trạng thái file và lý do từ chối.'
  
  indexes {
    request_id
    assignment_id
    booking_id
    file_source
    content_type
    created_by
    upload_date
    delivered_to_customer
    delivered_at
    delivered_by
    file_status
    reviewed_by
    reviewed_at
  }
}

// 13. Đặt lịch studio (Studio Bookings) - Single Studio System
Table studio_bookings {
  booking_id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [ref: > users.user_id, not null]
  studio_id uuid [ref: > studios.studio_id, not null]
  request_id uuid [ref: > service_requests.request_id] // Liên kết với service request
  contract_id uuid [ref: > contracts.contract_id] // Nullable cho booking nội bộ/walk-in
  
  // Recording session type
  session_type recording_session_type [not null]
  
  // Booking details
  booking_date date [not null]
  start_time time [not null] // CHECK: start_time < end_time
  end_time time [not null]
  status booking_status [default: 'tentative']
  hold_expires_at timestamp // Hết hạn giữ chỗ nếu chưa ký/cọc
  
  // Billing config & derivation
  billing_step_hours decimal(3,2) [default: 0.50] // Bước làm tròn (VD: 0.5h)
  min_billing_hours decimal(3,2) [default: 1.00] // Số giờ tối thiểu tính phí
  external_guest_count integer [default: 0] // Số khách ngoài đi kèm do khách mang vào
  
  // Session inputs (for scheduling & trace)
  duration_hours decimal(5,2) [not null] // Giờ đặt lịch (billable hours đã chốt trong contract)
  
  // Cost breakdown (for contract display)
  artist_fee decimal(12,2) [default: 0] // Phí nghệ sĩ
  equipment_rental_fee decimal(12,2) [default: 0] // Phí thiết bị
  admin_fee decimal(12,2) [default: 0] // Phí hỗ trợ
  external_guest_fee decimal(12,2) [default: 0] // Phí khách ngoài
  total_cost decimal(12,2) [default: 0] // Tổng chi phí
  
  // Session details
  purpose text // What will be recorded
  special_instructions text
  notes text
  created_at timestamp [default: `now()`]
  
  Note: 'Booking lưu giá chi tiết để show trong contract. Khi user thay đổi, update studio_bookings rồi update contract.total_price. Có thể tạo booking sớm ở trạng thái tentative (giữ chỗ). Khi hợp đồng ký/cọc xong, cập nhật status=confirmed và gán contract_id. Hết hạn giữ chỗ: hold_expires_at.'
  
  indexes {
    user_id
    studio_id
    request_id
    contract_id
    session_type
    booking_date
    status
  }
}

// 13.1 & 13.2: BỎ booking_artists và booking_required_equipment.
// Lý do: Luồng booking sẽ đọc nghệ sĩ/thiết bị trực tiếp từ request_booking_artists và request_booking_equipment theo request_id.

// 14. Thanh toán chi tiết (Payments)
Table payments {
  payment_id uuid [pk, default: `gen_random_uuid()`]
  milestone_id uuid [ref: > payment_milestones.milestone_id, not null]
  
  // Thông tin thanh toán
  amount decimal(12,2) [not null]
  currency currency_type [default: 'VND']
  payment_method payment_method [not null]
  
  // Liên kết với ví điện tử
  wallet_tx_id uuid [ref: > wallet_transactions.wallet_tx_id] // Nullable, chỉ có khi method='wallet'
  
  // Thông tin giao dịch
  transaction_id varchar(100)
  gateway_response text
  
  // Trạng thái và thời gian
  status payment_status [default: 'pending']
  payment_date timestamp
  processed_date timestamp
  
  notes text
  created_at timestamp [default: `now()`]
  
  Note: 'Thanh toán chi tiết theo milestone. Thanh toán luôn theo contract, không theo booking. CHECK: status <> not_required, (payment_method = wallet) = (wallet_tx_id IS NOT NULL)'
  
  indexes {
    milestone_id
    payment_method
    status
    wallet_tx_id
    payment_date
  }
}

// 15. Yêu cầu chỉnh sửa (Revision Requests) - Simple revision system
Table revision_requests {
  revision_id uuid [pk, default: `gen_random_uuid()`]
  contract_id uuid [ref: > contracts.contract_id, not null]
  assignment_id uuid [ref: > task_assignments.assignment_id] // Optional: biết revision thuộc task nào
  file_id uuid [ref: > files.file_id, not null]
  requested_by uuid [ref: > users.user_id, not null] // Ai yêu cầu revision
  
  // Revision tracking
  revision_number integer [not null] // Số thứ tự revision (1, 2, 3...)
  description text [not null]
  
  // Payment tracking for revisions
  payment_required boolean [default: false] // true = cần thanh toán trước khi làm
  payment_status payment_status [default: 'not_required'] // not_required | pending | paid | failed
  
  // Status
  status revision_status [default: 'pending'] // pending | approved | rejected | in_progress | completed | cancelled
  requested_at timestamp [default: `now()`]
  completed_at timestamp
  
  // Manager approval tracking
  approved_by uuid [ref: > users.user_id] // Manager duyệt revision
  approved_at timestamp // Khi nào duyệt
  rejected_by uuid [ref: > users.user_id] // Manager từ chối revision
  rejected_at timestamp // Khi nào từ chối
  rejection_reason text // Lý do từ chối
  
  Note: 'Yêu cầu chỉnh sửa với hệ thống đơn giản - request_id và user_id lấy qua contract_id. Manager duyệt revision trước khi specialist thực hiện.'
  
  indexes {
    contract_id
    assignment_id
    file_id
    requested_by
    (contract_id, revision_number) [unique] // Mỗi contract chỉ có 1 revision với số thứ tự duy nhất
    (contract_id, status)
    status
    requested_at
    approved_by
    approved_at
    rejected_by
    rejected_at
  }
}


// 16. Phản hồi (Feedback)
Table feedback {
  feedback_id uuid [pk, default: `gen_random_uuid()`]
  request_id uuid [ref: > service_requests.request_id, not null]
  user_id uuid [ref: > users.user_id, not null]
  rating integer [not null] // 1-5
  comment text
  feedback_type feedback_type [not null]
  created_at timestamp [default: `now()`]
  
  Note: 'Phản hồi từ khách hàng'
}

// 17. Thông báo (Notifications)
Table notifications {
  notification_id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [ref: > users.user_id, not null]
  title varchar(200) [not null]
  message text [not null]
  notification_type notification_type [not null]
  is_read boolean [default: false]
  created_at timestamp [default: `now()`]
  
  Note: 'Hệ thống thông báo - Enhanced với notification types mới'
  
  indexes {
    user_id
    is_read
    notification_type
    created_at
  }
}

// 18. Lịch sử hoạt động (Activity Logs)
Table activity_logs {
  log_id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [ref: > users.user_id]
  entity_type varchar(50) [not null]
  entity_id uuid [not null]
  action varchar(100) [not null]
  description text
  ip_address varchar(45)
  user_agent text
  created_at timestamp [default: `now()`]
  
  Note: 'Ghi log hoạt động của người dùng'
  
  indexes {
    user_id
    entity_type
    entity_id
    created_at
  }
}

// 19. Outbox Pattern - Event Publishing (Mỗi service có bảng riêng)
Table outbox_events {
  event_id uuid [pk, default: `gen_random_uuid()`] // Dùng làm idempotency key luôn
  aggregate_id uuid [not null] // ID của entity chính (contract_id, task_id, etc.)
  aggregate_type text [not null] // contract, task, payment, etc.
  event_type text [not null] // contract.signed, task.completed, etc.
  event_payload jsonb [not null] // Payload của event
  occurred_at timestamptz [not null, default: `now()`]
  
  // Publishing status (published_at IS NULL = pending)
  published_at timestamptz // NULL = pending, NOT NULL = published
  retry_count integer [not null, default: 0]
  last_error text
  next_retry_at timestamptz
  
  // Optional: distributed tracing
  trace_id text
  correlation_id text
  
  Note: 'Outbox pattern tối giản - event_id làm idempotency key, published_at IS NULL = pending'
  
  indexes {
    aggregate_id
    aggregate_type
    event_type
    occurred_at
    (next_retry_at) // Partial index cho pending events
  }
}

// 20. Event Processing Log - Idempotency (Mỗi service có bảng riêng)
Table consumed_events {
  event_id uuid [not null] // PK part 1 - event_id từ outbox
  consumer_name text [not null] // PK part 2 - tên service consumer
  processed_at timestamptz [not null, default: `now()`]
  
  Note: 'Idempotency tối giản - PK(event_id, consumer_name), INSERT ... ON CONFLICT DO NOTHING'
  
  indexes {
    (event_id, consumer_name) [unique, pk] // Composite primary key
    consumer_name
    processed_at
  }
}

// ===== ENUMS =====

Enum user_role {
  customer
  manager
  transcription_specialist
  arrangement_specialist
  recording_artist
  system_admin
}

Enum file_status {
  uploaded
  pending_review
  approved
  rejected
  delivered
  revision_requested
}

Enum contact_method {
  email
  phone
  sms
}

Enum specialist_type {
  transcription
  arrangement
  recording
}

Enum availability_status {
  available           // current_workload < max_concurrent_tasks
  can_take_more      // current_workload < max_concurrent_tasks (có thể nhận thêm)  
  busy               // current_workload = max_concurrent_tasks (đang full)
  overloaded         // current_workload > max_concurrent_tasks (quá tải)
  unavailable        // Không có sẵn (manual set)
  on_leave           // Đang nghỉ phép
}

Enum service_type {
  transcription
  arrangement
  arrangement_with_recording
  recording
}

Enum unit_type {
  per_minute      // Tính theo phút (transcription)
  per_song        // Tính theo bài (arrangement)
  per_hour        // Tính theo giờ (recording)
  fixed_price     // Giá cố định
}

Enum currency_type {
  VND
  USD
  EUR
}

Enum request_status {
  pending           // Chờ xử lý
  contract_sent    // NEW v3.0 - Đã gửi hợp đồng
  contract_signed  // NEW v3.0 - Khách đã ký hợp đồng
  approved         // Khách đồng ý, đã cọc
  in_progress      // Đang thực hiện
  completed        // Hoàn thành
  cancelled        // Đã hủy
  rejected         // Khách từ chối
}

Enum proficiency_level {
  beginner          // Mới học, ít kinh nghiệm
  intermediate      // Biết cơ bản, có thể làm task đơn giản
  advanced          // Thành thạo, có thể làm task phức tạp
  expert            // Chuyên gia, có thể dạy người khác
}

Enum milestone_type {
  deposit         // Tiền cọc
  final_payment   // Thanh toán cuối
  revision_fee    // Phí chỉnh sửa
}

Enum milestone_status {
  pending         // Chờ điều kiện
  due             // Đến hạn thanh toán
  paid            // Đã thanh toán
  overdue         // Quá hạn
}

Enum trigger_condition {
  contract_signed       // Hợp đồng đã ký
  project_started       // Dự án bắt đầu
  deliverable_sent      // Gửi deliverable
  project_completed     // Dự án hoàn thành
}

Enum task_type {
  transcription
  arrangement
  recording
}

Enum assignment_status {
  assigned         // Task đã được giao
  in_progress      // Đang thực hiện
  completed        // Hoàn thành
  cancelled        // Hủy bởi manager
}

Enum revision_status {
  pending         // Chờ manager duyệt
  approved        // Manager đã duyệt
  rejected        // Manager từ chối
  in_progress     // Specialist đang làm
  completed       // Hoàn thành
  cancelled       // Hủy bởi manager
}

Enum recording_session_type {
  self_recording          // Customer tự thu âm
  artist_assisted         // Thuê Recording Artist
  hybrid                  // Vừa tự thu vừa có artist
}

Enum booking_status {
  tentative      // Giữ chỗ trước khi ký hợp đồng/cọc
  pending
  confirmed
  in_progress
  completed
  cancelled
  no_show
}

Enum payment_method {
  credit_card
  debit_card
  bank_transfer
  digital_wallet
  wallet
  cash
}

Enum wallet_status {
  active
  locked
  closed
}

Enum wallet_tx_type {
  topup
  payment
  refund
  withdrawal
  adjustment
}

Enum payment_status {
  not_required    // Không cần thanh toán (free revision)
  pending         // Chờ thanh toán
  processing      // Đang xử lý thanh toán
  completed       // Thanh toán thành công
  failed          // Thanh toán thất bại
  refunded        // Hoàn tiền
  cancelled       // Hủy thanh toán
}

Enum feedback_type {
  service_quality
  communication
  timeliness
  overall_experience
}

Enum notification_type {
  task_assignment
  project_update
  payment_reminder
  booking_confirmation
  deadline_alert
  system_announcement
  contract_ready        // NEW v3.0
  contract_signed       // NEW v3.0
}

Enum file_source_type {
  customer_upload     // File khách hàng upload
  task_deliverable    // Kết quả từ task assignment
  studio_recording    // Raw recording từ studio
}

Enum content_type {
  audio              // Audio files (wav, mp3, etc.)
  sheet_music        // PDF, MIDI, MusicXML
  project_file       // DAW project files
  documentation      // Notes, lyrics, etc.
  video              // Video files
  archive            // Zip, rar files
}

Enum notation_instrument_usage {
  transcription
  arrangement
  both
}

Enum recording_role {
  vocalist         // Hát/giọng
  instrumentalist  // Chơi nhạc cụ
  both             // Vừa hát vừa chơi nhạc cụ
}

Enum contract_type {
  transcription
  arrangement
  arrangement_with_recording
  recording
}

Enum contract_status {
  draft
  sent_to_customer
  customer_reviewing
  signed
  expired
  cancelled
}


// REMOVED: arrangement_pricing_rule_type (v3.2)

// ===== BUSINESS RULES & TRIGGERS =====

// Trigger 1: Tự động hoá phí revision + đếm lần dùng
/*
CREATE OR REPLACE FUNCTION set_revision_payment_flags() RETURNS trigger AS $$
DECLARE v_free int; v_used int;
BEGIN
  SELECT free_revisions_included INTO v_free FROM contracts WHERE contract_id=NEW.contract_id;
  SELECT COALESCE(used_revisions,0) INTO v_used FROM task_assignments WHERE assignment_id=NEW.assignment_id;
  IF v_used < COALESCE(v_free,0) THEN
    NEW.payment_required := false; NEW.payment_status := 'not_required';
  ELSE
    NEW.payment_required := true;  NEW.payment_status := 'pending';
  END IF;
  RETURN NEW;
END $$ LANGUAGE plpgsql;

CREATE TRIGGER trg_revision_set_payment
BEFORE INSERT ON revision_requests FOR EACH ROW EXECUTE FUNCTION set_revision_payment_flags();

CREATE OR REPLACE FUNCTION bump_used_revisions_on_complete() RETURNS trigger AS $$
BEGIN
  IF NEW.status='completed' AND (OLD.status IS DISTINCT FROM 'completed') AND NEW.assignment_id IS NOT NULL THEN
    UPDATE task_assignments SET used_revisions = used_revisions + 1
    WHERE assignment_id = NEW.assignment_id;
  END IF;
  RETURN NEW;
END $$ LANGUAGE plpgsql;

CREATE TRIGGER trg_revision_completed_incr
AFTER UPDATE OF status ON revision_requests FOR EACH ROW EXECUTE FUNCTION bump_used_revisions_on_complete();
*/

// Trigger 1b: Booking - tính external_guest_fee từ external_guest_count và free limit
/*
CREATE OR REPLACE FUNCTION calc_external_guest_fee() RETURNS trigger AS $$
DECLARE
  v_excess int;
BEGIN
  v_excess := GREATEST(COALESCE(NEW.external_guest_count,0) - COALESCE(NEW.free_external_guests_limit,0), 0);
  NEW.external_guest_fee := COALESCE(NEW.extra_guest_fee_per_person,0) * v_excess;
  RETURN NEW;
END $$ LANGUAGE plpgsql;

CREATE TRIGGER trg_booking_external_guest_fee_ins
BEFORE INSERT ON studio_bookings FOR EACH ROW EXECUTE FUNCTION calc_external_guest_fee();
CREATE TRIGGER trg_booking_external_guest_fee_upd
BEFORE UPDATE OF external_guest_count, free_external_guests_limit, extra_guest_fee_per_person ON studio_bookings
FOR EACH ROW EXECUTE FUNCTION calc_external_guest_fee();
*/

// Trigger 2: Khoá ràng buộc loại task
/*
CREATE OR REPLACE FUNCTION enforce_task_matches_contract() RETURNS trigger AS $$
DECLARE v_type contract_type;
BEGIN
  SELECT contract_type INTO v_type FROM contracts WHERE contract_id=NEW.contract_id;
  IF NEW.task_type::text <> v_type::text THEN
    RAISE EXCEPTION 'task_type % must match contract.contract_type %', NEW.task_type, v_type;
  END IF;
  RETURN NEW;
END $$ LANGUAGE plpgsql;

CREATE TRIGGER trg_task_matches_contract
BEFORE INSERT OR UPDATE ON task_assignments FOR EACH ROW EXECUTE FUNCTION enforce_task_matches_contract();
*/

// Trigger 3: Cấm revision cho recording
/*
CREATE OR REPLACE FUNCTION forbid_recording_revisions() RETURNS trigger AS $$
DECLARE v_type task_type;
BEGIN
  IF NEW.assignment_id IS NOT NULL THEN
    SELECT task_type INTO v_type FROM task_assignments WHERE assignment_id=NEW.assignment_id;
    IF v_type='recording' THEN RAISE EXCEPTION 'Recording tasks do not support revisions'; END IF;
  END IF;
  RETURN NEW;
END $$ LANGUAGE plpgsql;

CREATE TRIGGER trg_forbid_recording_revisions
BEFORE INSERT ON revision_requests FOR EACH ROW EXECUTE FUNCTION forbid_recording_revisions();
*/

// Trigger 4: (ĐÃ BỎ) Booking Artists - ràng buộc nội bộ vs khách ngoài (KHÔNG DÙNG). Booking Artists chỉ lưu nội bộ.
/*
CREATE OR REPLACE FUNCTION enforce_booking_artist_constraints() RETURNS trigger AS $$
DECLARE v_cnt int;
BEGIN
  -- Case phân biệt external/internal
  IF NEW.is_external THEN
    IF NEW.specialist_id IS NOT NULL THEN
      RAISE EXCEPTION 'External artist must not have specialist_id';
    END IF;
    IF NEW.external_name IS NULL OR length(trim(NEW.external_name)) = 0 THEN
      RAISE EXCEPTION 'External artist requires external_name';
    END IF;
  ELSE
    IF NEW.specialist_id IS NULL THEN
      RAISE EXCEPTION 'Internal artist requires specialist_id';
    END IF;
  END IF;

  RETURN NEW;
END $$ LANGUAGE plpgsql;

CREATE TRIGGER trg_booking_artist_constraints
BEFORE INSERT OR UPDATE ON booking_artists FOR EACH ROW EXECUTE FUNCTION enforce_booking_artist_constraints();
*/

// Trigger 5 (tuỳ chọn): Chỉ kiểm tra skill mapping nếu có instrumentalist với skill có mapping
/*
CREATE OR REPLACE FUNCTION require_matching_equipment_for_instrumentalist() RETURNS trigger AS $$
DECLARE v_equipment_count int; v_skill_id uuid;
BEGIN
  -- Kiểm tra khi chốt/confirm booking
  IF NEW.status IN ('confirmed','in_progress') THEN
    -- Lấy skill_id của instrumentalist đầu tiên
    SELECT skill_id INTO v_skill_id FROM booking_artists ba
    WHERE ba.booking_id = NEW.booking_id AND (ba.role = 'instrumentalist' OR ba.role='both')
    LIMIT 1;
    
    -- Chỉ kiểm tra nếu có instrumentalist với skill có mapping
    IF v_skill_id IS NOT NULL AND EXISTS (SELECT 1 FROM skill_equipment_mapping WHERE skill_id = v_skill_id) THEN
      -- Kiểm tra có equipment phù hợp với skill không
      SELECT COUNT(*) INTO v_equipment_count
      FROM booking_required_equipment bre
      JOIN skill_equipment_mapping sem ON bre.equipment_id = sem.equipment_id
      WHERE bre.booking_id = NEW.booking_id AND sem.skill_id = v_skill_id;
      
      IF COALESCE(v_equipment_count,0) = 0 THEN
        RAISE EXCEPTION 'Instrumentalist skill % requires at least one matching equipment in booking_required_equipment', v_skill_id;
      END IF;
    END IF;
    -- Nếu không có skill mapping, không kiểm tra gì (cho phép thuê bất kỳ equipment nào)
  END IF;
  RETURN NEW;
END $$ LANGUAGE plpgsql;

CREATE TRIGGER trg_require_matching_equipment_for_instrumentalist
BEFORE UPDATE OF status ON studio_bookings FOR EACH ROW EXECUTE FUNCTION require_matching_equipment_for_instrumentalist();
*/

// Business Rule 1: Arrangement Workflow Validation
// Đảm bảo arrangement_option phù hợp với request_type
/*
CREATE OR REPLACE FUNCTION validate_arrangement_option()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.request_type = 'arrangement' THEN
    IF NEW.arrangement_option IS NULL THEN
      RAISE EXCEPTION 'arrangement_option is required for arrangement requests';
    END IF;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_validate_arrangement_option
  BEFORE INSERT OR UPDATE ON service_requests
  FOR EACH ROW
  EXECUTE FUNCTION validate_arrangement_option();
*/

// REMOVED: Arrangement Pricing Calculation function (v3.2) - pricing auto, không cần rule chi tiết

// Business Rule 2: Contract Creation Validation
// Đảm bảo contract được tạo sau khi service request được approved
/*
CREATE OR REPLACE FUNCTION validate_contract_creation()
RETURNS TRIGGER AS $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM service_requests 
    WHERE request_id = NEW.request_id 
      AND status = 'approved'
  ) THEN
    RAISE EXCEPTION 'Contract can only be created for approved service requests';
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_validate_contract_creation
  BEFORE INSERT ON contracts
  FOR EACH ROW
  EXECUTE FUNCTION validate_contract_creation();
*/

// Business Rule 3: AI Confidence Score Validation
// Đảm bảo AI confidence score trong khoảng hợp lệ
/*
CREATE OR REPLACE FUNCTION validate_ai_confidence()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.ai_confidence_score IS NOT NULL THEN
    IF NEW.ai_confidence_score < 0.00 OR NEW.ai_confidence_score > 1.00 THEN
      RAISE EXCEPTION 'AI confidence score must be between 0.00 and 1.00';
    END IF;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_validate_ai_confidence
  BEFORE INSERT OR UPDATE ON task_assignments
  FOR EACH ROW
  EXECUTE FUNCTION validate_ai_confidence();
*/

// ===== VIEWS & FUNCTIONS =====

// View: Enhanced Specialist Workload với AI capabilities
/*
CREATE VIEW specialist_workload_enhanced AS
SELECT 
  s.specialist_id,
  s.user_id,
  s.specialization,
  s.max_concurrent_tasks,
  COUNT(ta.assignment_id) as current_workload,
  COUNT(CASE WHEN ta.ai_assistance_used = true THEN 1 END) as ai_assisted_tasks,
  AVG(CASE WHEN ta.ai_assistance_used = true THEN ta.ai_confidence_score END) as avg_ai_confidence,
  CASE 
    WHEN COUNT(ta.assignment_id) = 0 THEN 'available'
    WHEN COUNT(ta.assignment_id) < s.max_concurrent_tasks THEN 'can_take_more'
    WHEN COUNT(ta.assignment_id) = s.max_concurrent_tasks THEN 'busy'
    WHEN COUNT(ta.assignment_id) > s.max_concurrent_tasks THEN 'overloaded'
    ELSE 'unavailable'
  END as calculated_availability_status
FROM specialists s
LEFT JOIN task_assignments ta ON s.specialist_id = ta.specialist_id 
  AND ta.status IN ('assigned', 'in_progress')
GROUP BY s.specialist_id, s.user_id, s.specialization, s.max_concurrent_tasks;
*/

// View: Contract Status Overview (UPDATED v3.2 - no quotations)
/*
CREATE VIEW contract_status_overview AS
SELECT 
  c.contract_id,
  c.contract_number,
  c.contract_type,
  c.status,
  c.created_at,
  c.signed_at,
  c.expires_at,
  sr.title as request_title,
  u.full_name as customer_name,
  uc.full_name as manager_name,
  c.total_price,
  c.currency
FROM contracts c
JOIN service_requests sr ON c.request_id = sr.request_id
JOIN users u ON c.user_id = u.user_id
JOIN users uc ON c.manager_user_id = uc.user_id
ORDER BY c.created_at DESC;
*/

// Function: Get Arrangement Workflow Status (UPDATED v3.2 - no quotations)
/*
CREATE OR REPLACE FUNCTION get_arrangement_workflow_status(p_request_id UUID)
RETURNS TABLE(
  request_id UUID,
  requires_vocalist BOOLEAN,
  pricing_discussion_completed BOOLEAN,
  contract_created BOOLEAN,
  contract_signed BOOLEAN,
  artist_selected BOOLEAN,
  current_status TEXT
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    sr.request_id,
    sr.arrangement_option,
    sr.requires_vocalist,
    sr.pricing_discussion_completed,
    (c.contract_id IS NOT NULL) as contract_created,
    (c.status = 'signed') as contract_signed,
    (ar.recommendation_id IS NOT NULL AND ar.customer_choice = true) as artist_selected,
    CASE 
      WHEN NOT sr.pricing_discussion_completed THEN 'Pricing Discussion'
      WHEN c.contract_id IS NULL THEN 'Contract Creation'
      WHEN c.status != 'signed' THEN 'Contract Signing'
      WHEN sr.requires_vocalist AND (ar.recommendation_id IS NULL OR ar.customer_choice = false) THEN 'Artist Selection'
      ELSE 'Ready for Project Creation'
    END as current_status
  FROM service_requests sr
  LEFT JOIN contracts c ON c.request_id = sr.request_id
  LEFT JOIN artist_recommendations ar ON sr.request_id = ar.request_id AND ar.customer_choice = true
  WHERE sr.request_id = p_request_id;
END;
$$ LANGUAGE plpgsql;
*/

// ========================================
// WALLET SYSTEM TRIGGERS
// ========================================

/*
-- Trigger: Tự động cập nhật số dư ví khi có giao dịch mới
CREATE OR REPLACE FUNCTION update_wallet_balance()
RETURNS TRIGGER AS $$
DECLARE
  current_balance DECIMAL(14,2);
  new_balance DECIMAL(14,2);
BEGIN
  -- Lấy số dư hiện tại
  SELECT balance INTO current_balance FROM wallets WHERE wallet_id = NEW.wallet_id;
  
  -- Tính số dư mới dựa trên loại giao dịch
  CASE NEW.tx_type
    WHEN 'topup', 'refund' THEN
      new_balance := current_balance + NEW.amount;
    WHEN 'payment', 'withdrawal' THEN
      -- Kiểm tra số dư không âm
      IF current_balance < NEW.amount THEN
        RAISE EXCEPTION 'Insufficient wallet balance. Current: %, Required: %', current_balance, NEW.amount;
      END IF;
      new_balance := current_balance - NEW.amount;
    WHEN 'adjustment' THEN
      -- Adjustment có thể âm hoặc dương
      new_balance := current_balance + NEW.amount;
  END CASE;
  
  -- Cập nhật số dư trong ví
  UPDATE wallets SET balance = new_balance WHERE wallet_id = NEW.wallet_id;
  
  -- Cập nhật balance_before và balance_after
  NEW.balance_before := current_balance;
  NEW.balance_after := new_balance;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_update_wallet_balance
  BEFORE INSERT ON wallet_transactions
  FOR EACH ROW
  EXECUTE FUNCTION update_wallet_balance();

-- Trigger: Tự động tạo giao dịch ví khi thanh toán bằng ví
CREATE OR REPLACE FUNCTION create_wallet_payment_transaction()
RETURNS TRIGGER AS $$
DECLARE
  customer_wallet_id UUID;
  wallet_tx_id UUID;
BEGIN
  -- Chỉ xử lý khi payment_method = 'wallet'
  IF NEW.payment_method = 'wallet' THEN
    -- Lấy wallet_id của customer từ milestone -> contract -> customer
    SELECT w.wallet_id INTO customer_wallet_id
    FROM wallets w
    JOIN users u ON w.user_id = u.user_id
    JOIN contracts ct ON ct.user_id = u.user_id
    JOIN payment_milestones pm ON pm.contract_id = ct.contract_id
    WHERE pm.milestone_id = NEW.milestone_id;
    
    -- Tạo giao dịch ví
    INSERT INTO wallet_transactions (
      wallet_id, tx_type, amount, balance_before, balance_after, related_payment_id
    ) VALUES (
      customer_wallet_id, 'payment', NEW.amount, 0, 0, NEW.payment_id
    ) RETURNING wallet_tx_id INTO wallet_tx_id;
    
    -- Cập nhật wallet_tx_id vào payment
    NEW.wallet_tx_id := wallet_tx_id;
    NEW.status := 'completed';
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_create_wallet_payment_transaction
  BEFORE INSERT ON payments
  FOR EACH ROW
  EXECUTE FUNCTION create_wallet_payment_transaction();

-- Trigger: Tự động tạo ví khi customer mới được tạo
CREATE OR REPLACE FUNCTION create_customer_wallet()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO wallets (user_id, balance, currency, status)
  VALUES (NEW.user_id, 0, 'VND', 'active');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_create_customer_wallet
  AFTER INSERT ON users
  FOR EACH ROW
  WHEN (NEW.role = 'customer')
  EXECUTE FUNCTION create_customer_wallet();
*/
