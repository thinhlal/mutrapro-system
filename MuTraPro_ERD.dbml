// ERD HOÀN CHỈNH cho hệ thống MuTraPro 
// Custom Music Transcription and Production System
// Tác giả: [Tên sinh viên]
// Ngày tạo: [Ngày hiện tại]
// Version: 2.0 - Enhanced Payment System

Project MuTraPro {
  database_type: 'PostgreSQL'
  Note: '''
    Hệ thống ký âm và sản xuất âm nhạc theo yêu cầu
    Custom Music Transcription and Production System
    
    Features:
    - Multi-role user management
    - Automated quotation system
    - Milestone-based payments
    - Studio booking management
    - Complete workflow tracking
  '''
}

// ===== CÁC THỰC THỂ CHÍNH =====

// 1. Người dùng (Users)
Table users {
  user_id uuid [pk, increment]
  username varchar(50) [unique, not null]
  email varchar(100) [unique, not null]
  password_hash varchar(255) [not null]
  full_name varchar(100) [not null]
  phone varchar(20)
  address text
  role user_role [not null]
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Note: 'Bảng chứa thông tin tất cả người dùng trong hệ thống'
  
  indexes {
    email [unique]
    username [unique]
    role
    is_active
  }
}

// 1.5. Vai trò người dùng (User Roles) - Support đa vai trò
Table user_roles {
  user_role_id uuid [pk, increment]
  user_id uuid [ref: > users.user_id, not null]
  role user_role [not null]
  assigned_at timestamp [default: `now()`]
  assigned_by uuid [ref: > users.user_id]
  is_active boolean [default: true]
  
  Note: 'Bảng quản lý đa vai trò cho người dùng. Một user có thể có nhiều role'
  
  indexes {
    (user_id, role) [unique]
    user_id
    role
    is_active
  }
}

// 2. Khách hàng (Customers)
Table customers {
  customer_id uuid [pk, increment]
  user_id uuid [ref: > users.user_id, not null]
  customer_type customer_type [default: 'individual']
  company_name varchar(100)
  tax_id varchar(20)
  preferred_contact_method contact_method [default: 'email']
  notes text
  
  Note: 'Thông tin chi tiết của khách hàng'
}

// 3. Chuyên gia (Specialists)
Table specialists {
  specialist_id uuid [pk, increment]
  user_id uuid [ref: > users.user_id, not null]
  specialization specialist_type [not null]
  experience_years integer [default: 0]
  hourly_rate decimal(10,2)
  
  // Capacity management
  max_concurrent_tasks integer [default: 5] // Số task tối đa có thể làm cùng lúc
  current_workload integer [default: 0] // Số task hiện tại đang làm
  availability_status availability_status [default: 'available'] // Auto calculated
  
  skills text[]
  portfolio_url varchar(255)
  rating decimal(3,2) [default: 0.00]
  total_projects integer [default: 0]
  
  Note: 'Thông tin chuyên gia với workload capacity management'
  
  indexes {
    specialization
    availability_status
    current_workload
    max_concurrent_tasks
  }
}

// 4. Điều phối viên dịch vụ (Service Coordinators)
Table service_coordinators {
  coordinator_id uuid [pk, increment]
  user_id uuid [ref: > users.user_id, not null]
  department varchar(50)
  max_concurrent_projects integer [default: 10]
  
  Note: 'Điều phối viên quản lý và phân công công việc'
}

// 5. Quản trị viên studio (Studio Administrators)
Table studio_administrators {
  admin_id uuid [pk, increment]
  user_id uuid [ref: > users.user_id, not null]
  studio_id uuid [ref: > studios.studio_id, not null]
  permissions text[]
  
  Note: 'Quản trị viên studio quản lý tài nguyên và lịch đặt'
}

// 6. Studio
Table studios {
  studio_id uuid [pk, increment]
  studio_name varchar(100) [not null]
  location varchar(255) [not null]
  capacity integer [not null]
  equipment text[]
  hourly_rate decimal(10,2) [not null]
  is_active boolean [default: true]
  description text
  
  Note: 'Thông tin studio ghi âm'
}

// 7. Bảng giá chuẩn (Pricing Matrix)
Table pricing_matrix {
  pricing_id uuid [pk, increment]
  service_type service_type [not null]
  complexity_level complexity_level [not null]
  unit_type unit_type [not null]
  base_price_vnd decimal(12,2) [not null]
  base_price_usd decimal(10,2) [not null]
  min_price_vnd decimal(12,2)
  max_price_vnd decimal(12,2)
  description text
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Note: 'Bảng giá chuẩn theo service type và độ phức tạp'
  
  indexes {
    service_type
    complexity_level
    is_active
  }
}

// 8. Yêu cầu dịch vụ (Service Requests)
Table service_requests {
  request_id uuid [pk, increment]
  customer_id uuid [ref: > customers.customer_id, not null]
  coordinator_id uuid [ref: > service_coordinators.coordinator_id]
  request_type service_type [not null]
  title varchar(200) [not null]
  description text [not null]
  priority priority_level [default: 'medium']
  status request_status [default: 'pending']
  estimated_duration integer // tính bằng giờ
  actual_duration integer
  budget decimal(10,2)
  deadline timestamp
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Note: 'Yêu cầu dịch vụ từ khách hàng'
  
  indexes {
    customer_id
    coordinator_id
    status
    request_type
    created_at
    deadline
  }
}

// 9. Báo giá (Quotations)
Table quotations {
  quotation_id uuid [pk, increment]
  request_id uuid [ref: > service_requests.request_id, not null]
  coordinator_id uuid [ref: > service_coordinators.coordinator_id, not null]
  customer_id uuid [ref: > customers.customer_id, not null]
  
  // Thông tin phân tích
  audio_duration_minutes decimal(6,2)
  complexity_level complexity_level [not null]
  estimated_hours integer
  
  // Giá chi tiết
  base_price decimal(12,2) [not null]
  complexity_multiplier decimal(3,2) [default: 1.0]
  additional_fees decimal(12,2) [default: 0]
  discount_percent decimal(5,2) [default: 0]
  total_price decimal(12,2) [not null]
  currency currency_type [default: 'VND']
  
  // Thanh toán theo giai đoạn
  deposit_percent decimal(5,2) [default: 40.0]
  deposit_amount decimal(12,2) [not null]
  final_amount decimal(12,2) [not null]
  
  // Delivery type và rush info
  delivery_type delivery_pricing_type [default: 'normal']
  rush_fee_amount decimal(12,2) [default: 0] // Phí rush riêng biệt
  overtime_fee_amount decimal(12,2) [default: 0] // Phí overtime riêng biệt
  
  // Trạng thái và thời gian
  status quotation_status [default: 'sent']
  valid_until timestamp
  notes text
  created_at timestamp [default: `now()`]
  approved_at timestamp
  
  Note: 'Báo giá chi tiết cho từng service request'
  
  indexes {
    request_id [unique]
    customer_id
    coordinator_id
    status
    valid_until
  }
}

// 11. Dự án (Projects)
Table projects {
  project_id uuid [pk, increment]
  request_id uuid [ref: > service_requests.request_id, not null]
  quotation_id uuid [ref: > quotations.quotation_id, not null]
  customer_id uuid [ref: > customers.customer_id, not null]
  project_name varchar(200) [not null]
  status project_status [default: 'assigned']
  start_date timestamp
  end_date timestamp
  progress_percentage integer [default: 0]
  notes text
  
  Note: 'Dự án được tạo từ yêu cầu dịch vụ. Có customer_id để query nhanh'
  
  indexes {
    customer_id
    status
    (customer_id, status)
    start_date
  }
}

// 12. Thanh toán theo giai đoạn (Payment Milestones)
Table payment_milestones {
  milestone_id uuid [pk, increment]
  quotation_id uuid [ref: > quotations.quotation_id, not null]
  request_id uuid [ref: > service_requests.request_id, not null]
  customer_id uuid [ref: > customers.customer_id, not null]
  
  milestone_type milestone_type [not null]
  milestone_name varchar(100) [not null]
  description text
  amount decimal(12,2) [not null]
  percentage decimal(5,2) [not null]
  
  // Điều kiện kích hoạt
  trigger_condition trigger_condition [not null]
  required_deliverable_count integer [default: 0]
  
  // Trạng thái thanh toán
  status milestone_status [default: 'pending']
  due_date timestamp
  completed_at timestamp
  
  Note: 'Các mốc thanh toán theo giai đoạn'
  
  indexes {
    quotation_id
    request_id
    milestone_type
    status
    due_date
  }
}

// 13. Phân công công việc (Task Assignments)
Table task_assignments {
  assignment_id uuid [pk, increment]
  project_id uuid [ref: > projects.project_id, not null]
  specialist_id uuid [ref: > specialists.specialist_id, not null]
  task_type task_type [not null]
  status assignment_status [default: 'assigned']
  
  // Timeline management
  assigned_date timestamp [default: `now()`]
  start_date date [not null] // Ngày bắt đầu làm
  due_date timestamp [not null]
  estimated_hours decimal(6,2) [not null] // Dự kiến cần bao nhiêu giờ
  
  // Priority management  
  priority priority_level [default: 'medium']
  is_rush_job boolean [default: false]
  rush_fee_multiplier decimal(3,2) [default: 1.0] // 1.3x cho rush, 1.5x cho overtime
  
  // Overtime workflow
  overtime_requested boolean [default: false] // Coordinator có hỏi overtime không
  overtime_approved_by_specialist boolean [default: null] // Specialist response
  overtime_requested_at timestamp // Khi nào coordinator hỏi
  overtime_response_at timestamp // Khi nào specialist trả lời
  overtime_reason text // Lý do specialist accept/decline
  
  completed_date timestamp
  actual_hours decimal(6,2) // Thực tế làm bao nhiêu giờ
  notes text
  
  Note: 'Phân công công việc với timeline và priority management'
  
  indexes {
    project_id
    specialist_id
    status
    start_date
    due_date
    priority
    is_rush_job
  }
}

// 13.1. Lịch làm việc của specialist (Specialist Schedule)
Table specialist_schedules {
  schedule_id uuid [pk, increment]
  specialist_id uuid [ref: > specialists.specialist_id, not null]
  
  // Time block details
  date date [not null]
  start_time time [not null]
  end_time time [not null]
  
  // Schedule type
  schedule_type schedule_type [not null]
  
  // References to what's scheduled
  assignment_id uuid [ref: > task_assignments.assignment_id] // NULL if not work-related
  booking_id uuid [ref: > studio_bookings.booking_id] // NULL if not studio-related
  
  // Status and details
  status schedule_status [default: 'confirmed']
  hours_allocated decimal(4,2) [not null] // Số giờ phân bổ
  description text
  is_recurring boolean [default: false] // Có lặp lại không (VD: meeting hàng tuần)
  
  // Split session tracking
  is_overtime boolean [default: false] // Có phải overtime slot không
  split_session_order integer [default: null] // Thứ tự nếu task bị split (1, 2, 3...)
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Note: 'Lịch chi tiết của specialist - track từng time slot để tính availability'
  
  indexes {
    specialist_id
    date
    schedule_type
    status
    assignment_id
    booking_id
  }
}

// 14. File Management (Unified Files Table)
Table files {
  file_id uuid [pk, increment]
  
  // Source references (one of these will be NULL)
  request_id uuid [ref: > service_requests.request_id]           // Customer uploads
  assignment_id uuid [ref: > task_assignments.assignment_id]     // Task deliverables
  booking_id uuid [ref: > studio_bookings.booking_id]            // Studio recordings
  
  // File metadata
  file_name varchar(255) [not null]
  file_path varchar(500) [not null]
  file_size bigint [not null]
  file_type varchar(50) [not null]
  
  // File classification
  file_source file_source_type [not null]
  content_type content_type [not null]
  processing_stage processing_stage [default: 'raw']
  
  // Version and status
  version varchar(20) [default: '1.0']
  is_final boolean [default: false]
  
  // Audio-specific metadata (JSON for flexibility)
  audio_metadata jsonb // duration, sample_rate, bit_depth, etc.
  
  // General metadata
  description text
  upload_date timestamp [default: `now()`]
  created_by uuid [ref: > users.user_id] // WHO uploaded this
  
  Note: 'Quản lý tất cả files trong hệ thống - deliverables, recordings, attachments'
  
  indexes {
    request_id
    assignment_id
    booking_id
    file_source
    content_type
    processing_stage
    created_by
    upload_date
  }
}

// 15. Đặt lịch studio (Studio Bookings) - Enhanced for 2 Recording Models
Table studio_bookings {
  booking_id uuid [pk, increment]
  customer_id uuid [ref: > customers.customer_id, not null]
  studio_id uuid [ref: > studios.studio_id, not null]
  project_id uuid [ref: > projects.project_id]
  
  // Recording session type
  session_type recording_session_type [not null]
  recording_artist_id uuid [ref: > specialists.specialist_id] // NULL if self-recording
  
  // Booking details
  booking_date date [not null]
  start_time time [not null]
  end_time time [not null]
  status booking_status [default: 'pending']
  
  // Cost breakdown
  studio_cost decimal(10,2) [not null] // Studio hourly rate
  artist_cost decimal(10,2) [default: 0] // Artist fee (0 if self-recording)
  admin_support_cost decimal(10,2) [default: 0] // Technical support fee
  total_cost decimal(10,2) [not null]
  
  // Session details
  purpose text // What will be recorded
  equipment_requirements text[]
  special_instructions text
  notes text
  created_at timestamp [default: `now()`]
  
  Note: 'Đặt lịch studio - Hỗ trợ 2 mô hình: Tự thu và Thuê Artist'
  
  indexes {
    customer_id
    studio_id
    recording_artist_id
    session_type
    booking_date
    status
  }
}

// 16. Thanh toán chi tiết (Payments)
Table payments {
  payment_id uuid [pk, increment]
  milestone_id uuid [ref: > payment_milestones.milestone_id, not null]
  request_id uuid [ref: > service_requests.request_id, not null]
  customer_id uuid [ref: > customers.customer_id, not null]
  
  // Thông tin thanh toán
  amount decimal(12,2) [not null]
  currency currency_type [default: 'VND']
  payment_method payment_method [not null]
  
  // Thông tin giao dịch
  transaction_id varchar(100)
  gateway_response text
  
  // Trạng thái và thời gian
  status payment_status [default: 'pending']
  payment_date timestamp
  processed_date timestamp
  
  // Metadata
  ip_address varchar(45)
  user_agent text
  notes text
  created_at timestamp [default: `now()`]
  
  Note: 'Thanh toán chi tiết theo milestone'
  
  indexes {
    milestone_id
    request_id
    customer_id
    transaction_id
    status
    payment_date
  }
}

// 17. Yêu cầu chỉnh sửa (Revision Requests)
Table revision_requests {
  revision_id uuid [pk, increment]
  request_id uuid [ref: > service_requests.request_id, not null]
  project_id uuid [ref: > projects.project_id, not null]
  file_id uuid [ref: > files.file_id, not null]
  customer_id uuid [ref: > customers.customer_id, not null]
  
  revision_type revision_type [not null]
  description text [not null]
  
  // Cost impact
  additional_cost decimal(12,2) [default: 0]
  additional_hours integer [default: 0]
  
  // Status
  status revision_status [default: 'pending']
  requested_at timestamp [default: `now()`]
  approved_at timestamp
  completed_at timestamp
  
  Note: 'Yêu cầu chỉnh sửa file deliverable. Có project_id để dễ tracking theo dự án'
  
  indexes {
    request_id
    project_id
    file_id
    customer_id
    (project_id, status)
    status
    requested_at
  }
}

// 18. Gói giao nộp (Deliverable Packages)
Table deliverable_packages {
  package_id uuid [pk, increment]
  project_id uuid [ref: > projects.project_id, not null]
  customer_id uuid [ref: > customers.customer_id, not null]
  
  package_name varchar(200) [not null]
  description text
  delivery_type delivery_type [default: 'final']
  
  // Status tracking
  status delivery_status [default: 'preparing']
  prepared_by uuid [ref: > users.user_id]
  prepared_at timestamp
  delivered_at timestamp
  approved_by_customer_at timestamp
  
  // Customer feedback
  customer_notes text
  requires_revision boolean [default: false]
  
  Note: 'Gói giao nộp chính thức. Mỗi package chứa nhiều files'
  
  indexes {
    project_id
    customer_id
    status
    delivery_type
    delivered_at
  }
}

// 18.5. Files trong gói giao nộp (Package Files)
Table package_files {
  package_file_id uuid [pk, increment]
  package_id uuid [ref: > deliverable_packages.package_id, not null]
  file_id uuid [ref: > files.file_id, not null]
  file_order integer [default: 1]
  is_primary boolean [default: false]
  
  Note: 'Liên kết giữa deliverable packages và files'
  
  indexes {
    package_id
    file_id
    (package_id, file_order)
    is_primary
  }
}

// 19. Phản hồi (Feedback)
Table feedback {
  feedback_id uuid [pk, increment]
  request_id uuid [ref: > service_requests.request_id, not null]
  customer_id uuid [ref: > customers.customer_id, not null]
  rating integer [not null] // 1-5
  comment text
  feedback_type feedback_type [not null]
  created_at timestamp [default: `now()`]
  
  Note: 'Phản hồi từ khách hàng'
}

// 19. Thông báo (Notifications)
Table notifications {
  notification_id uuid [pk, increment]
  user_id uuid [ref: > users.user_id, not null]
  title varchar(200) [not null]
  message text [not null]
  notification_type notification_type [not null]
  is_read boolean [default: false]
  created_at timestamp [default: `now()`]
  
  Note: 'Hệ thống thông báo'
  
  indexes {
    user_id
    is_read
    notification_type
    created_at
  }
}

// 20. Lịch sử hoạt động (Activity Logs)
Table activity_logs {
  log_id uuid [pk, increment]
  user_id uuid [ref: > users.user_id]
  entity_type varchar(50) [not null]
  entity_id uuid [not null]
  action varchar(100) [not null]
  description text
  ip_address varchar(45)
  user_agent text
  created_at timestamp [default: `now()`]
  
  Note: 'Ghi log hoạt động của người dùng'
  
  indexes {
    user_id
    entity_type
    entity_id
    created_at
  }
}

// ===== ENUMS =====

Enum user_role {
  customer
  transcription_specialist
  arrangement_specialist
  recording_artist
  service_coordinator
  studio_administrator
  system_admin
}

Enum customer_type {
  individual
  business
  organization
}

Enum contact_method {
  email
  phone
  sms
}

Enum specialist_type {
  transcription
  arrangement
  recording
  mixing
  mastering
}

Enum availability_status {
  available           // current_workload < max_concurrent_tasks
  can_take_more      // current_workload < max_concurrent_tasks (có thể nhận thêm)  
  busy               // current_workload = max_concurrent_tasks (đang full)
  overloaded         // current_workload > max_concurrent_tasks (quá tải)
  unavailable        // Không có sẵn (manual set)
  on_leave           // Đang nghỉ phép
}

Enum schedule_type {
  work_task        // Làm task được assign
  studio_session   // Phiên thu âm tại studio
  meeting         // Họp, trao đổi
  break_time      // Nghỉ giữa giờ
  personal_leave  // Nghỉ phép cá nhân
  sick_leave      // Nghỉ ốm
  training        // Đào tạo, học hỏi
  admin_work      // Công việc hành chính
}

Enum schedule_status {
  confirmed       // Đã xác nhận
  tentative      // Tạm thời, chưa chắc chắn
  cancelled      // Đã hủy
  completed      // Đã hoàn thành
  in_progress    // Đang thực hiện
}

Enum service_type {
  transcription
  arrangement
  recording
  mixing
  mastering
  full_production
}

Enum complexity_level {
  simple          // Đơn giản (1 track, melody đơn)
  moderate        // Trung bình (2-5 tracks, harmony cơ bản)
  complex         // Phức tạp (6-10 tracks, advanced harmony)
  professional    // Chuyên nghiệp (10+ tracks, orchestral)
  virtuoso        // Siêu khó (classical, jazz, experimental)
}

Enum unit_type {
  per_minute      // Tính theo phút (transcription)
  per_song        // Tính theo bài (arrangement)
  per_hour        // Tính theo giờ (recording)
  fixed_price     // Giá cố định
}

Enum currency_type {
  VND
  USD
  EUR
}

Enum priority_level {
  low
  medium
  high
  urgent
}

Enum request_status {
  pending           // Chờ xử lý
  quoted           // Đã có báo giá, chờ khách phản hồi
  approved         // Khách đồng ý, đã cọc
  in_progress      // Đang thực hiện
  completed        // Hoàn thành
  cancelled        // Đã hủy
  rejected         // Khách từ chối
}

Enum quotation_status {
  sent            // Đã gửi khách hàng
  approved        // Khách hàng chấp nhận
  rejected        // Khách hàng từ chối
  expired         // Hết hạn
}

Enum project_status {
  assigned
  in_progress
  review
  completed
  cancelled
}

Enum milestone_type {
  deposit         // Tiền cọc
  final_payment   // Thanh toán cuối
  revision_fee    // Phí chỉnh sửa
  rush_fee        // Phí gấp
}

Enum milestone_status {
  pending         // Chờ điều kiện
  due             // Đến hạn thanh toán
  paid            // Đã thanh toán
  overdue         // Quá hạn
}

Enum trigger_condition {
  quotation_approved    // Báo giá được duyệt
  project_started       // Dự án bắt đầu
  deliverable_sent      // Gửi deliverable
  project_completed     // Dự án hoàn thành
}

Enum task_type {
  transcription
  arrangement
  recording
  mixing
  mastering
  review
}

Enum assignment_status {
  assigned
  accepted
  in_progress
  completed
  rejected
  overdue
}

Enum revision_type {
  minor_adjustment      // Chỉnh sửa nhỏ (free)
  major_change         // Thay đổi lớn (có phí)
  scope_expansion      // Mở rộng phạm vi
  style_change         // Đổi style
}

Enum revision_status {
  pending
  approved
  in_progress
  completed
  rejected
}

Enum delivery_type {
  draft           // Bản nháp để review
  milestone       // Giao nộp theo milestone
  final           // Giao nộp cuối cùng
  revision        // Giao nộp sau revision
}

Enum delivery_status {
  preparing       // Đang chuẩn bị
  ready           // Sẵn sàng giao
  delivered       // Đã giao cho customer
  approved        // Customer đã approve
  rejected        // Customer reject, cần revision
}

Enum delivery_pricing_type {
  normal          // Delivery bình thường
  rush_split      // Rush job với split sessions (+30%)
  rush_overtime   // Rush job với specialist overtime (+50%)
}

Enum recording_session_type {
  self_recording          // Customer tự thu âm
  artist_assisted         // Thuê Recording Artist
  hybrid                  // Vừa tự thu vừa có artist
}

Enum booking_status {
  pending
  confirmed
  in_progress
  completed
  cancelled
  no_show
}

Enum payment_method {
  credit_card
  debit_card
  bank_transfer
  digital_wallet
  cash
}

Enum payment_status {
  pending
  processing
  completed
  failed
  refunded
  cancelled
}

Enum feedback_type {
  service_quality
  communication
  timeliness
  overall_experience
}

Enum notification_type {
  task_assignment
  project_update
  payment_reminder
  booking_confirmation
  deadline_alert
  system_announcement
}

Enum quality_level {
  demo            // Demo quality
  standard        // Standard quality
  professional    // Professional quality
  audiophile      // Audiophile quality
}

Enum file_source_type {
  customer_upload     // File khách hàng upload
  task_deliverable    // Kết quả từ task assignment
  studio_recording    // Raw recording từ studio
  processed_output    // File đã xử lý
}

Enum content_type {
  audio              // Audio files (wav, mp3, etc.)
  sheet_music        // PDF, MIDI, MusicXML
  project_file       // DAW project files
  documentation      // Notes, lyrics, etc.
  video              // Video files
  archive            // Zip, rar files
}

Enum processing_stage {
  raw                // File gốc chưa xử lý
  draft              // Bản nháp
  reviewed           // Đã review
  revised            // Đã chỉnh sửa
  processed          // Đã xử lý cơ bản
  mixed              // Đã mix
  mastered           // Đã master
  final              // File cuối cùng
  archived           // Đã lưu trữ
}
