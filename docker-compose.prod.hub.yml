version: '3.8'

# ============================================
# Docker Compose với Images từ Docker Hub
# ============================================
# File này dùng pre-built images từ Docker Hub
# Thay vì build local, chỉ cần pull và chạy
#
# Cách dùng:
# 1. Build và push images: ./scripts/build-and-push.sh
# 2. Trên EC2: docker-compose -f docker-compose.prod.hub.yml pull
# 3. Trên EC2: docker-compose -f docker-compose.prod.hub.yml up -d
#
# Thay đổi DOCKER_HUB_USERNAME trong .env nếu cần

services:
  kafka:
    image: redpandadata/redpanda:latest
    container_name: mutrapro-kafka
    command: >-
      redpanda start --overprovisioned --smp 1 --memory 1G --reserve-memory 0M
      --node-id 0 --check=false --kafka-addr PLAINTEXT://0.0.0.0:9092
      --advertise-kafka-addr PLAINTEXT://kafka:9092
    networks:
      - mutrapro-network
    restart: unless-stopped

  # API Gateway
  api-gateway:
    image: ${DOCKER_HUB_USERNAME:-mutrapro}/api-gateway:latest
    container_name: mutrapro-api-gateway
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # Server Configuration (match với application-prod.yml)
      - SERVER_PORT=${SERVER_PORT:-8080}
      # Redis configuration (match với application-prod.yml: ${REDIS_HOST})
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      # JWT để validate tokens từ clients
      - JWT_SIGNER_KEY=${JWT_SECRET}
      # API Gateway configuration (match với application-prod.yml)
      - API_PREFIX=${API_PREFIX:-/api/v1}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}
      # Service URIs (match với application-prod.yml routes)
      - IDENTITY_URI=${IDENTITY_URI:-http://identity-service:8081}
      - PROJECT_URI=${PROJECT_URI:-http://project-service:8082}
      - REQUEST_URI=${REQUEST_URI:-http://request-service:8084}
      - BILLING_URI=${BILLING_URI:-http://billing-service:8083}
      - SPECIALIST_URI=${SPECIALIST_URI:-http://specialist-service:8086}
      - NOTIFICATION_URI=${NOTIFICATION_URI:-http://notification-service:8085}
      - CHAT_URI=${CHAT_URI:-http://chat-service:8088}
    networks:
      - mutrapro-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Identity Service
  identity-service:
    image: ${DOCKER_HUB_USERNAME:-mutrapro}/identity-service:latest
    container_name: mutrapro-identity-service
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # Server Configuration (match với application-prod.yml)
      - SERVER_PORT=${SERVER_PORT:-8081}
      - SERVER_CONTEXT_PATH=${SERVER_CONTEXT_PATH:-}
      # Connect đến external database trên Railway (match với application-prod.yml: ${DATABASE_URL})
      - DATABASE_URL=${IDENTITY_DATASOURCE_URL}
      - DATABASE_USERNAME=${IDENTITY_DATASOURCE_USERNAME}
      - DATABASE_PASSWORD=${IDENTITY_DATASOURCE_PASSWORD}
      # Redis configuration (match với application-prod.yml: ${REDIS_HOST})
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      # Connect đến Kafka (external hoặc local container) - để publish events
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      - JWT_SIGNER_KEY=${JWT_SECRET}
      # JWT Configuration (match với application-prod.yml)
      - ACCESS_TOKEN_EXPIRY_SECONDS=${ACCESS_TOKEN_EXPIRY_SECONDS:-3600}
      - REFRESH_TOKEN_EXPIRY_DAYS=${REFRESH_TOKEN_EXPIRY_DAYS:-7}
      # Outbox Configuration (match với application-prod.yml)
      - OUTBOX_MAX_RETRIES=${OUTBOX_MAX_RETRIES:-3}
      # Kafka Topic Names (match với application-prod.yml - có default values)
      - KAFKA_TOPIC_EMAIL_VERIFICATION=${KAFKA_TOPIC_EMAIL_VERIFICATION:-email-verification}
      - KAFKA_TOPIC_PASSWORD_RESET=${KAFKA_TOPIC_PASSWORD_RESET:-password-reset}
      # OAuth configuration (optional)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI:-}
    # Nếu dùng external Kafka, comment out depends_on này
    # Nếu dùng local Kafka container, giữ lại depends_on
    depends_on:
      - kafka
    networks:
      - mutrapro-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Project Service
  project-service:
    image: ${DOCKER_HUB_USERNAME:-mutrapro}/project-service:latest
    container_name: mutrapro-project-service
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # Server Configuration (match với application-prod.yml)
      - SERVER_PORT=${SERVER_PORT:-8082}
      - SERVER_CONTEXT_PATH=${SERVER_CONTEXT_PATH:-}
      # Connect đến external database trên Railway (match với application-prod.yml: ${DATABASE_URL})
      - DATABASE_URL=${PROJECT_DATASOURCE_URL}
      - DATABASE_USERNAME=${PROJECT_DATASOURCE_USERNAME}
      - DATABASE_PASSWORD=${PROJECT_DATASOURCE_PASSWORD}
      # Connect đến Kafka (external hoặc local container) - consumer & producer
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      - KAFKA_CONSUMER_GROUP_ID=${KAFKA_CONSUMER_GROUP_ID:-project-service-file-consumer}
      # JWT để validate tokens từ API Gateway
      - JWT_SIGNER_KEY=${JWT_SECRET}
      # AWS S3 Configuration (cho file storage - match với application-prod.yml)
      - AWS_S3_ENABLED=${AWS_S3_ENABLED:-true}
      - AWS_S3_BUCKET_NAME=${AWS_S3_BUCKET_NAME:-mutrapro-prod-files}
      - AWS_S3_REGION=${AWS_S3_REGION:-ap-southeast-1}
      - AWS_S3_ACCESS_KEY=${AWS_ACCESS_KEY_ID}
      - AWS_S3_SECRET_KEY=${AWS_SECRET_ACCESS_KEY}
      # Service URLs (match với application-prod.yml)
      - REQUEST_SERVICE_URL=${REQUEST_SERVICE_URL:-http://request-service:8084}
      - CHAT_SERVICE_URL=${CHAT_SERVICE_URL:-http://chat-service:8088}
      - BILLING_SERVICE_URL=${BILLING_SERVICE_URL:-http://billing-service:8083}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL:-http://notification-service:8085}
      - SPECIALIST_SERVICE_URL=${SPECIALIST_SERVICE_URL:-http://specialist-service:8086}
      # E-Signature Configuration (match với application-prod.yml)
      - ESIGN_OTP_EXPIRATION_MINUTES=${ESIGN_OTP_EXPIRATION_MINUTES:-5}
      - ESIGN_OTP_MAX_ATTEMPTS=${ESIGN_OTP_MAX_ATTEMPTS:-3}
      - ESIGN_OTP_LENGTH=${ESIGN_OTP_LENGTH:-6}
      # Kafka Topic Names (match với application-prod.yml - có default values)
      - KAFKA_TOPIC_FILE_UPLOADED=${KAFKA_TOPIC_FILE_UPLOADED:-file-uploaded}
      - KAFKA_TOPIC_CONTRACT_OTP_EMAIL=${KAFKA_TOPIC_CONTRACT_OTP_EMAIL:-contract-otp-email}
      - KAFKA_TOPIC_CONTRACT_SIGNED=${KAFKA_TOPIC_CONTRACT_SIGNED:-contract-events}
      - KAFKA_TOPIC_CONTRACT_SIGNED_EMAIL=${KAFKA_TOPIC_CONTRACT_SIGNED_EMAIL:-contract-signed-email}
      - KAFKA_TOPIC_BILLING_DEPOSIT_PAID=${KAFKA_TOPIC_BILLING_DEPOSIT_PAID:-billing-deposit-paid}
      - KAFKA_TOPIC_BILLING_MILESTONE_PAID=${KAFKA_TOPIC_BILLING_MILESTONE_PAID:-billing-milestone-paid}
      - KAFKA_TOPIC_BILLING_REVISION_FEE_PAID=${KAFKA_TOPIC_BILLING_REVISION_FEE_PAID:-billing-revision-fee-paid}
      - KAFKA_TOPIC_TASK_ASSIGNMENT_ASSIGNED=${KAFKA_TOPIC_TASK_ASSIGNMENT_ASSIGNED:-task-assignment-assigned}
      - KAFKA_TOPIC_TASK_ASSIGNMENT_READY_TO_START=${KAFKA_TOPIC_TASK_ASSIGNMENT_READY_TO_START:-task-assignment-ready-to-start}
      - KAFKA_TOPIC_TASK_ASSIGNMENT_CANCELED=${KAFKA_TOPIC_TASK_ASSIGNMENT_CANCELED:-task-assignment-canceled}
      - KAFKA_TOPIC_TASK_ISSUE_REPORTED=${KAFKA_TOPIC_TASK_ISSUE_REPORTED:-task-issue-reported}
      - KAFKA_TOPIC_CONTRACT_NOTIFICATION=${KAFKA_TOPIC_CONTRACT_NOTIFICATION:-contract-notification}
      - KAFKA_TOPIC_SUBMISSION_DELIVERED=${KAFKA_TOPIC_SUBMISSION_DELIVERED:-submission-delivered}
      - KAFKA_TOPIC_REVISION_REQUESTED=${KAFKA_TOPIC_REVISION_REQUESTED:-revision-requested}
      - KAFKA_TOPIC_REVISION_DELIVERED=${KAFKA_TOPIC_REVISION_DELIVERED:-revision-delivered}
      - KAFKA_TOPIC_REVISION_SUBMITTED=${KAFKA_TOPIC_REVISION_SUBMITTED:-revision-submitted}
      - KAFKA_TOPIC_REVISION_APPROVED=${KAFKA_TOPIC_REVISION_APPROVED:-revision-approved}
      - KAFKA_TOPIC_REVISION_REJECTED=${KAFKA_TOPIC_REVISION_REJECTED:-revision-rejected}
      - KAFKA_TOPIC_MILESTONE_PAID_NOTIFICATION=${KAFKA_TOPIC_MILESTONE_PAID_NOTIFICATION:-milestone-paid-notification}
      - KAFKA_TOPIC_MILESTONE_READY_FOR_PAYMENT_NOTIFICATION=${KAFKA_TOPIC_MILESTONE_READY_FOR_PAYMENT_NOTIFICATION:-milestone-ready-for-payment-notification}
      - KAFKA_TOPIC_BILLING_REVISION_FEE_REFUNDED=${KAFKA_TOPIC_BILLING_REVISION_FEE_REFUNDED:-billing-revision-fee-refunded}
      - KAFKA_TOPIC_CHAT_SYSTEM_MESSAGE=${KAFKA_TOPIC_CHAT_SYSTEM_MESSAGE:-chat-system-message-events}
    # Nếu dùng external Kafka, comment out depends_on này
    # Nếu dùng local Kafka container, giữ lại depends_on
    depends_on:
      - kafka
    networks:
      - mutrapro-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Billing Service
  billing-service:
    image: ${DOCKER_HUB_USERNAME:-mutrapro}/billing-service:latest
    container_name: mutrapro-billing-service
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # Server Configuration (match với application-prod.yml)
      - SERVER_PORT=${SERVER_PORT:-8083}
      - SERVER_CONTEXT_PATH=${SERVER_CONTEXT_PATH:-}
      # Connect đến external database trên Railway (match với application-prod.yml: ${DATABASE_URL})
      - DATABASE_URL=${BILLING_DATASOURCE_URL}
      - DATABASE_USERNAME=${BILLING_DATASOURCE_USERNAME}
      - DATABASE_PASSWORD=${BILLING_DATASOURCE_PASSWORD}
      # Connect đến Kafka (external hoặc local container)
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      - KAFKA_CONSUMER_GROUP_ID=${KAFKA_CONSUMER_GROUP_ID:-billing-service}
      - JWT_SIGNER_KEY=${JWT_SECRET}
      # Kafka Topic Names (match với application-prod.yml - có default values)
      - KAFKA_TOPIC_BILLING_DEPOSIT_PAID=${KAFKA_TOPIC_BILLING_DEPOSIT_PAID:-billing-deposit-paid}
      - KAFKA_TOPIC_BILLING_MILESTONE_PAID=${KAFKA_TOPIC_BILLING_MILESTONE_PAID:-billing-milestone-paid}
      - KAFKA_TOPIC_BILLING_REVISION_FEE_PAID=${KAFKA_TOPIC_BILLING_REVISION_FEE_PAID:-billing-revision-fee-paid}
      - KAFKA_TOPIC_BILLING_REVISION_FEE_REFUNDED=${KAFKA_TOPIC_BILLING_REVISION_FEE_REFUNDED:-billing-revision-fee-refunded}
    # Nếu dùng external Kafka, comment out depends_on này
    # Nếu dùng local Kafka container, giữ lại depends_on
    depends_on:
      - kafka
    networks:
      - mutrapro-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Request Service
  request-service:
    image: ${DOCKER_HUB_USERNAME:-mutrapro}/request-service:latest
    container_name: mutrapro-request-service
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # Server Configuration (match với application-prod.yml)
      - SERVER_PORT=${SERVER_PORT:-8084}
      - SERVER_CONTEXT_PATH=${SERVER_CONTEXT_PATH:-}
      # Connect đến external database trên Railway (match với application-prod.yml: ${DATABASE_URL})
      - DATABASE_URL=${REQUEST_DATASOURCE_URL}
      - DATABASE_USERNAME=${REQUEST_DATASOURCE_USERNAME}
      - DATABASE_PASSWORD=${REQUEST_DATASOURCE_PASSWORD}
      # Connect đến Kafka (external hoặc local container) - producer
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      # JWT để validate tokens từ API Gateway
      - JWT_SIGNER_KEY=${JWT_SECRET}
      # AWS S3 Configuration (cho file storage - match với application-prod.yml)
      - AWS_S3_BUCKET_NAME=${AWS_S3_BUCKET_NAME}
      - AWS_REGION=${AWS_REGION:-ap-southeast-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      # Service URLs (match với application-prod.yml)
      - PROJECT_SERVICE_BASE_URL=${PROJECT_SERVICE_BASE_URL:-http://project-service:8082}
      - IDENTITY_SERVICE_BASE_URL=${IDENTITY_SERVICE_BASE_URL:-http://identity-service:8081}
      # Outbox Configuration (match với application-prod.yml)
      - OUTBOX_MAX_RETRIES=${OUTBOX_MAX_RETRIES:-3}
      # Kafka Topic Names (match với application-prod.yml - có default values)
      - KAFKA_TOPIC_FILE_UPLOADED=${KAFKA_TOPIC_FILE_UPLOADED:-file-uploaded}
      - KAFKA_TOPIC_REQUEST_ASSIGNED=${KAFKA_TOPIC_REQUEST_ASSIGNED:-request-events}
    # Nếu dùng external Kafka, comment out depends_on này
    # Nếu dùng local Kafka container, giữ lại depends_on
    depends_on:
      - kafka
    networks:
      - mutrapro-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Notification Service
  notification-service:
    image: ${DOCKER_HUB_USERNAME:-mutrapro}/notification-service:latest
    container_name: mutrapro-notification-service
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # Server Configuration (match với application-prod.yml)
      - SERVER_PORT=${SERVER_PORT:-8085}
      - SERVER_CONTEXT_PATH=${SERVER_CONTEXT_PATH:-}
      # Connect đến external database trên Railway (match với application-prod.yml: ${DATABASE_URL})
      - DATABASE_URL=${NOTIFICATION_DATASOURCE_URL}
      - DATABASE_USERNAME=${NOTIFICATION_DATASOURCE_USERNAME}
      - DATABASE_PASSWORD=${NOTIFICATION_DATASOURCE_PASSWORD}
      # Connect đến Kafka (external hoặc local container)
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      - KAFKA_CONSUMER_GROUP_ID=${KAFKA_CONSUMER_GROUP_ID:-notification-service}
      # Mail configuration (match với application-prod.yml)
      - MAIL_HOST=${MAIL_HOST:-smtp.gmail.com}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME:-MuTraPro}
      - FRONTEND_URL=${FRONTEND_URL:-https://mutrapro.com}
      # JWT để validate tokens từ API Gateway
      - JWT_SIGNER_KEY=${JWT_SECRET}
      # Kafka Topic Names (match với application-prod.yml - có default values)
      - KAFKA_TOPIC_EMAIL_VERIFICATION=${KAFKA_TOPIC_EMAIL_VERIFICATION:-email-verification}
      - KAFKA_TOPIC_PASSWORD_RESET=${KAFKA_TOPIC_PASSWORD_RESET:-password-reset}
      - KAFKA_TOPIC_CONTRACT_OTP_EMAIL=${KAFKA_TOPIC_CONTRACT_OTP_EMAIL:-contract-otp-email}
      - KAFKA_TOPIC_CONTRACT_SIGNED_EMAIL=${KAFKA_TOPIC_CONTRACT_SIGNED_EMAIL:-contract-signed-email}
      - KAFKA_TOPIC_TASK_ASSIGNMENT_ASSIGNED=${KAFKA_TOPIC_TASK_ASSIGNMENT_ASSIGNED:-task-assignment-assigned}
      - KAFKA_TOPIC_TASK_ASSIGNMENT_READY_TO_START=${KAFKA_TOPIC_TASK_ASSIGNMENT_READY_TO_START:-task-assignment-ready-to-start}
      - KAFKA_TOPIC_TASK_ASSIGNMENT_CANCELED=${KAFKA_TOPIC_TASK_ASSIGNMENT_CANCELED:-task-assignment-canceled}
      - KAFKA_TOPIC_TASK_ISSUE_REPORTED=${KAFKA_TOPIC_TASK_ISSUE_REPORTED:-task-issue-reported}
      - KAFKA_TOPIC_CONTRACT_NOTIFICATION=${KAFKA_TOPIC_CONTRACT_NOTIFICATION:-contract-notification}
      - KAFKA_TOPIC_CHAT_ROOM_CREATED=${KAFKA_TOPIC_CHAT_ROOM_CREATED:-chat-events}
      - KAFKA_TOPIC_SUBMISSION_DELIVERED=${KAFKA_TOPIC_SUBMISSION_DELIVERED:-submission-delivered}
      - KAFKA_TOPIC_REVISION_REQUESTED=${KAFKA_TOPIC_REVISION_REQUESTED:-revision-requested}
      - KAFKA_TOPIC_REVISION_DELIVERED=${KAFKA_TOPIC_REVISION_DELIVERED:-revision-delivered}
      - KAFKA_TOPIC_REVISION_SUBMITTED=${KAFKA_TOPIC_REVISION_SUBMITTED:-revision-submitted}
      - KAFKA_TOPIC_REVISION_APPROVED=${KAFKA_TOPIC_REVISION_APPROVED:-revision-approved}
      - KAFKA_TOPIC_REVISION_REJECTED=${KAFKA_TOPIC_REVISION_REJECTED:-revision-rejected}
      - KAFKA_TOPIC_BILLING_REVISION_FEE_REFUNDED=${KAFKA_TOPIC_BILLING_REVISION_FEE_REFUNDED:-billing-revision-fee-refunded}
      - KAFKA_TOPIC_MILESTONE_PAID_NOTIFICATION=${KAFKA_TOPIC_MILESTONE_PAID_NOTIFICATION:-milestone-paid-notification}
      - KAFKA_TOPIC_MILESTONE_READY_FOR_PAYMENT_NOTIFICATION=${KAFKA_TOPIC_MILESTONE_READY_FOR_PAYMENT_NOTIFICATION:-milestone-ready-for-payment-notification}
    # Nếu dùng external Kafka, comment out depends_on này
    # Nếu dùng local Kafka container, giữ lại depends_on
    depends_on:
      - kafka
    networks:
      - mutrapro-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Specialist Service
  specialist-service:
    image: ${DOCKER_HUB_USERNAME:-mutrapro}/specialist-service:latest
    container_name: mutrapro-specialist-service
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # Server Configuration (match với application-prod.yml)
      - SERVER_PORT=${SERVER_PORT:-8086}
      - SERVER_CONTEXT_PATH=${SERVER_CONTEXT_PATH:-}
      # Connect đến external database trên Railway (match với application-prod.yml: ${DATABASE_URL})
      - DATABASE_URL=${SPECIALIST_DATASOURCE_URL}
      - DATABASE_USERNAME=${SPECIALIST_DATASOURCE_USERNAME}
      - DATABASE_PASSWORD=${SPECIALIST_DATASOURCE_PASSWORD}
      # JWT để validate tokens từ API Gateway
      - JWT_SIGNER_KEY=${JWT_SECRET}
    networks:
      - mutrapro-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Chat Service
  chat-service:
    image: ${DOCKER_HUB_USERNAME:-mutrapro}/chat-service:latest
    container_name: mutrapro-chat-service
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # Connect đến external database trên Railway (match với application-prod.yml: ${DATABASE_URL})
      - DATABASE_URL=${CHAT_DATASOURCE_URL}
      - DATABASE_USERNAME=${CHAT_DATASOURCE_USERNAME}
      - DATABASE_PASSWORD=${CHAT_DATASOURCE_PASSWORD}
      # Server Configuration (match với application-prod.yml)
      - SERVER_PORT=${SERVER_PORT:-8088}
      # Connect đến Kafka (external hoặc local container)
      # Nếu có managed Kafka, set KAFKA_BOOTSTRAP_SERVERS trong .env
      # Nếu dùng local container, dùng kafka:9092
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      - KAFKA_CONSUMER_GROUP_ID=${KAFKA_CONSUMER_GROUP_ID:-chat-service}
      - JWT_SIGNER_KEY=${JWT_SECRET}
      # JWT Configuration (match với application-prod.yml)
      - JWT_VALID_DURATION=${JWT_VALID_DURATION:-3600}
      - JWT_REFRESHABLE_DURATION=${JWT_REFRESHABLE_DURATION:-86400}
      # Outbox Configuration (match với application-prod.yml)
      - OUTBOX_MAX_RETRIES=${OUTBOX_MAX_RETRIES:-3}
      # Service URLs (match với application-prod.yml)
      - NOTIFICATION_SERVICE_BASE_URL=${NOTIFICATION_SERVICE_BASE_URL:-http://notification-service:8085}
      # Swagger Configuration (match với application-prod.yml)
      - SWAGGER_ENABLED=${SWAGGER_ENABLED:-false}
      # Kafka Topic Names (match với application-prod.yml - có default values)
      - KAFKA_TOPIC_REQUEST_ASSIGNED=${KAFKA_TOPIC_REQUEST_ASSIGNED:-request-events}
      - KAFKA_TOPIC_CONTRACT_SIGNED=${KAFKA_TOPIC_CONTRACT_SIGNED:-contract-events}
      - KAFKA_TOPIC_CHAT_ROOM_CREATED=${KAFKA_TOPIC_CHAT_ROOM_CREATED:-chat-events}
      - KAFKA_TOPIC_CHAT_SYSTEM_MESSAGE=${KAFKA_TOPIC_CHAT_SYSTEM_MESSAGE:-chat-system-message-events}
    # Nếu dùng external Kafka, comment out depends_on này
    # Nếu dùng local Kafka container, giữ lại depends_on
    depends_on:
      - kafka
    networks:
      - mutrapro-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: mutrapro-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - api-gateway
      - identity-service
      - project-service
      - billing-service
      - request-service
      - notification-service
      - specialist-service
      - chat-service
    networks:
      - mutrapro-network
    restart: unless-stopped
    # Healthcheck đơn giản: kiểm tra nginx config
    healthcheck:
      test: ["CMD-SHELL", "nginx -t || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  mutrapro-network:
    driver: bridge

