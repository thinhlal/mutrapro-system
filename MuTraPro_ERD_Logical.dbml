// ERD LOGICAL MODEL cho hệ thống MuTraPro
// Custom Music Transcription and Production System
// Tác giả: [Tên sinh viên]
// Ngày tạo: [Ngày hiện tại]
// Version: 1.0 - Logical Data Model

Project MuTraPro_Logical {
  database_type: 'PostgreSQL'
  Note: '''
    Hệ thống ký âm và sản xuất âm nhạc theo yêu cầu
    Custom Music Transcription and Production System
    
    LOGICAL MODEL - Business Entities and Relationships
    
    Main Workflows:
    1. Transcription with AI assistance
    2. Arrangement with optional vocalist + Contract management
    3. Studio booking with multi-artist selection
    
    Business Rules:
    - Users can be customers, managers, or specialists
    - Each customer has one wallet for payments
    - Contracts link requests to pricing and milestones
    - Tasks are assigned to specialists based on skills
    - Studio bookings support multiple artists and equipment
    - Files are delivered through assignments
    - Revisions are tracked per contract
  '''
}

// ===== BUSINESS ENTITIES =====

// 1. User Management
Table users {
  user_id [pk]
  email [unique]
  password_hash
  full_name
  role
  phone
  address
  is_active
  created_at
  updated_at
  
  Note: 'Central user entity - customers, managers, specialists'
}

Table specialists {
  specialist_id [pk]
  user_id [ref: > users.user_id]
  bio
  hourly_rate
  is_available
  rating
  total_projects
  created_at
  updated_at
  
  Note: 'Specialist profiles with skills and availability'
}

// 2. Wallet System
Table wallets {
  wallet_id [pk]
  user_id [ref: > users.user_id, unique]
  balance
  currency
  status
  created_at
  
  Note: 'Customer e-wallet for payments'
}

Table wallet_transactions {
  wallet_tx_id [pk]
  wallet_id [ref: > wallets.wallet_id]
  tx_type
  amount
  currency
  balance_before
  balance_after
  related_payment_id [ref: > payments.payment_id]
  metadata
  created_at
  
  Note: 'Wallet transaction ledger'
}

// 3. Service Management
Table service_requests {
  request_id [pk]
  user_id [ref: > users.user_id]
  manager_user_id [ref: > users.user_id]
  request_type
  contact_name
  contact_phone
  contact_email
  music_options
  tempo_percentage
  has_vocalist
  external_guest_count
  title
  description
  status
  created_at
  updated_at
  
  Note: 'Customer service requests'
}

Table contracts {
  contract_id [pk]
  request_id [ref: > service_requests.request_id]
  user_id [ref: > users.user_id]
  manager_user_id [ref: > users.user_id]
  contract_number [unique]
  contract_type
  terms_and_conditions
  special_clauses
  status
  created_at
  sent_to_customer_at
  customer_reviewed_at
  signed_at
  expires_at
  file_id [ref: > files.file_id]
  notes
  base_price
  total_price
  currency
  deposit_percent
  deposit_amount
  final_amount
  deposit_paid
  deposit_paid_at
  expected_start_date
  due_date
  sla_days
  auto_due_date
  free_revisions_included
  additional_revision_fee_vnd
  name_snapshot
  phone_snapshot
  email_snapshot
  
  Note: 'Service contracts with pricing and terms'
}

// 4. Task Management
Table task_assignments {
  assignment_id [pk]
  contract_id [ref: > contracts.contract_id]
  specialist_id [ref: > specialists.specialist_id]
  task_type
  status
  priority
  description
  notes
  assigned_at
  started_at
  completed_at
  due_date
  used_revisions
  specialist_can_do
  specialist_response_reason
  specialist_responded_at
  
  Note: 'Task assignments to specialists'
}

// 5. File Management
Table files {
  file_id [pk]
  assignment_id [ref: > task_assignments.assignment_id]
  file_name
  file_path
  file_size
  file_type
  content_type
  file_source
  uploaded_by [ref: > users.user_id]
  uploaded_at
  delivered_to_customer
  delivered_at
  delivered_by [ref: > users.user_id]
  
  Note: 'File storage and delivery tracking'
}

// 6. Studio Management
Table studios {
  studio_id [pk]
  studio_name
  location
  hourly_rate
  free_external_guests_limit
  extra_guest_fee_per_person
  is_active
  
  Note: 'Studio information and policies'
}

Table studio_bookings {
  booking_id [pk]
  user_id [ref: > users.user_id]
  studio_id [ref: > studios.studio_id]
  request_id [ref: > service_requests.request_id]
  contract_id [ref: > contracts.contract_id]
  session_type
  booking_date
  start_time
  end_time
  duration_hours
  status
  notes
  artist_fee
  equipment_rental_fee
  admin_fee
  external_guest_fee
  total_cost
  external_guest_count
  hold_expires_at
  created_at
  
  Note: 'Studio booking sessions'
}

// 7. Artist and Equipment Management
Table skills {
  skill_id [pk]
  skill_name
  skill_type
  description
  is_active
  
  Note: 'Specialist skills and capabilities'
}

Table equipment {
  equipment_id [pk]
  equipment_name
  brand
  model
  description
  specifications
  rental_fee
  total_quantity
  maintenance_quantity
  is_active
  created_at
  updated_at
  
  Note: 'Equipment inventory'
}

Table notation_instruments {
  instrument_id [pk]
  instrument_name
  instrument_type
  description
  usage_type
  is_active
  
  Note: 'Virtual instruments for notation'
}

// 8. Request Selections
Table request_notation_instruments {
  request_notation_instrument_id [pk]
  request_id [ref: > service_requests.request_id]
  instrument_id [ref: > notation_instruments.instrument_id]
  
  Note: 'Customer instrument selections for requests'
}

Table request_booking_artists {
  request_booking_artist_id [pk]
  request_id [ref: > service_requests.request_id]
  specialist_id [ref: > specialists.specialist_id]
  
  Note: 'Customer artist selections for studio booking'
}

Table request_booking_equipment {
  request_booking_equipment_id [pk]
  request_id [ref: > service_requests.request_id]
  equipment_id [ref: > equipment.equipment_id]
  quantity
  
  Note: 'Customer equipment selections for studio booking'
}

// 9. Booking Details
Table booking_artists {
  booking_artist_id [pk]
  booking_id [ref: > studio_bookings.booking_id]
  specialist_id [ref: > specialists.specialist_id]
  role
  skill_id [ref: > skills.skill_id]
  fee
  
  Note: 'Artists assigned to studio bookings'
}

Table booking_required_equipment {
  booking_equipment_id [pk]
  booking_id [ref: > studio_bookings.booking_id]
  equipment_id [ref: > equipment.equipment_id]
  quantity
  rental_fee
  
  Note: 'Equipment required for studio bookings'
}

// 10. Payment Management
Table payment_milestones {
  milestone_id [pk]
  contract_id [ref: > contracts.contract_id]
  milestone_type
  amount
  currency
  description
  status
  due_date
  completed_at
  
  Note: 'Payment milestones for contracts'
}

Table payments {
  payment_id [pk]
  milestone_id [ref: > payment_milestones.milestone_id]
  amount
  currency
  payment_method
  wallet_tx_id [ref: > wallet_transactions.wallet_tx_id]
  transaction_id
  gateway_response
  status
  payment_date
  processed_date
  notes
  created_at
  
  Note: 'Payment transactions'
}

// 11. Revision Management
Table revision_requests {
  revision_id [pk]
  contract_id [ref: > contracts.contract_id]
  assignment_id [ref: > task_assignments.assignment_id]
  file_id [ref: > files.file_id]
  description
  requested_by [ref: > users.user_id]
  assigned_to [ref: > specialists.specialist_id]
  status
  requested_at
  completed_at
  payment_required
  payment_status
  
  Note: 'Revision requests for deliverables'
}

// 12. Feedback and Notifications
Table feedback {
  feedback_id [pk]
  request_id [ref: > service_requests.request_id]
  user_id [ref: > users.user_id]
  rating
  comment
  feedback_type
  created_at
  
  Note: 'Customer feedback'
}

Table notifications {
  notification_id [pk]
  user_id [ref: > users.user_id]
  title
  message
  notification_type
  is_read
  created_at
  
  Note: 'System notifications'
}

// 13. Configuration
Table service_sla_defaults {
  sla_id [pk]
  contract_type
  min_sla_days
  max_sla_days
  default_buffer_days
  
  Note: 'Default SLA settings by contract type'
}

Table pricing_matrix {
  pricing_id [pk]
  service_type
  complexity_level
  base_price
  currency
  is_active
  
  Note: 'Pricing configuration'
}

Table skill_equipment_mapping {
  mapping_id [pk]
  skill_id [ref: > skills.skill_id]
  equipment_id [ref: > equipment.equipment_id]
  is_required
  
  Note: 'Skills and compatible equipment mapping'
}

// ===== BUSINESS RULES =====

// Business Rule 1: User Roles
Ref: users.role -> user_role

// Business Rule 2: Contract Types
Ref: contracts.contract_type -> contract_type

// Business Rule 3: Service Types
Ref: service_requests.request_type -> service_type

// Business Rule 4: Payment Methods
Ref: payments.payment_method -> payment_method

// Business Rule 5: Wallet Transaction Types
Ref: wallet_transactions.tx_type -> wallet_tx_type

// Business Rule 6: Task Assignment Status
Ref: task_assignments.status -> assignment_status

// Business Rule 7: Studio Booking Status
Ref: studio_bookings.status -> booking_status

// Business Rule 8: Revision Status
Ref: revision_requests.status -> revision_status

// Business Rule 9: Payment Status
Ref: payments.status -> payment_status

// Business Rule 10: Wallet Status
Ref: wallets.status -> wallet_status

// ===== BUSINESS CONSTRAINTS =====

// Constraint 1: One wallet per user
Ref: wallets.user_id [unique]

// Constraint 2: One contract per request
Ref: contracts.request_id [unique]

// Constraint 3: Payment method validation
Ref: payments.payment_method -> payment_method

// Constraint 4: Wallet transaction validation
Ref: wallet_transactions.tx_type -> wallet_tx_type

// Constraint 5: Task type matches contract type
Ref: task_assignments.task_type -> contract_type

// Constraint 6: Revision payment validation
Ref: revision_requests.payment_status -> payment_status

// Constraint 7: Studio booking session type
Ref: studio_bookings.session_type -> recording_session_type

// Constraint 8: Equipment usage type
Ref: notation_instruments.usage_type -> notation_instrument_usage

// Constraint 9: Skill type validation
Ref: skills.skill_type -> skill_type

// Constraint 10: Feedback type validation
Ref: feedback.feedback_type -> feedback_type

// ===== BUSINESS WORKFLOWS =====

// Workflow 1: Transcription Process
// 1. Customer creates service_request (transcription)
// 2. Manager creates contract
// 3. Manager assigns task to specialist
// 4. Specialist uploads notation file
// 5. Customer reviews and requests revisions if needed
// 6. Final delivery and payment

// Workflow 2: Arrangement Process
// 1. Customer creates service_request (arrangement)
// 2. Customer selects notation instruments
// 3. Manager creates contract
// 4. Manager assigns task to specialist
// 5. Specialist creates arrangement
// 6. Customer reviews and requests revisions
// 7. Final delivery and payment

// Workflow 3: Studio Booking Process
// 1. Customer creates service_request (studio_booking)
// 2. Customer selects artists and equipment
// 3. Manager creates contract
// 4. Manager creates studio_booking
// 5. Session execution
// 6. File delivery and payment

// ===== DATA INTEGRITY RULES =====

// Rule 1: Contract must have valid request
// Rule 2: Task assignment must match contract type
// Rule 3: Payment must be linked to milestone
// Rule 4: Wallet transaction must update balance
// Rule 5: Revision must be within contract limits
// Rule 6: Studio booking must have valid session type
// Rule 7: File delivery must be tracked
// Rule 8: User role must be valid
// Rule 9: Equipment must be available
// Rule 10: Specialist must be available for assignment
